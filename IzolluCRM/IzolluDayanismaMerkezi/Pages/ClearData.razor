@page "/clear-data"
@using Microsoft.EntityFrameworkCore
@using IzolluVakfi.Data
@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Veritabanı Temizleme</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudPaper Class="pa-6">
        <MudText Typo="Typo.h4" Class="mb-4">⚠️ Veritabanı Temizleme</MudText>
        
        <MudAlert Severity="Severity.Error" Class="mb-4">
            <MudText><strong>DİKKAT:</strong> Bu işlem geri alınamaz!</MudText>
            <MudText>Tüm öğrenciler, mezun öğrenciler ve ilişkili tüm kayıtlar silinecektir.</MudText>
        </MudAlert>

        <MudStack Spacing="3">
            <MudText Typo="Typo.h6">Silinecek Kayıtlar:</MudText>
            <MudList T="string">
                <MudListItem T="string" Icon="@Icons.Material.Filled.Person">
                    Tüm Öğrenciler (@_studentCount kayıt)
                </MudListItem>
                <MudListItem T="string" Icon="@Icons.Material.Filled.School">
                    Tüm Mezun Öğrenciler (@_graduateCount kayıt)
                </MudListItem>
                <MudListItem T="string" Icon="@Icons.Material.Filled.Description">
                    Tüm Transkript Kayıtları (@_transcriptCount kayıt)
                </MudListItem>
                <MudListItem T="string" Icon="@Icons.Material.Filled.Event">
                    Tüm Toplantı Katılım Kayıtları (@_attendanceCount kayıt)
                </MudListItem>
                <MudListItem T="string" Icon="@Icons.Material.Filled.Payment">
                    Tüm Burs Ödeme Kayıtları (@_paymentCount kayıt)
                </MudListItem>
            </MudList>

            @if (_isClearing)
            {
                <MudProgressLinear Color="Color.Error" Indeterminate="true" Class="my-4" />
                <MudText Align="Align.Center">Veriler siliniyor, lütfen bekleyin...</MudText>
            }
            else if (_isCleared)
            {
                <MudAlert Severity="Severity.Success" Class="my-4">
                    ✅ Tüm öğrenci kayıtları başarıyla silindi!
                </MudAlert>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           OnClick="@(() => Navigation.NavigateTo("/students"))"
                           FullWidth="true">
                    Öğrenciler Sayfasına Git
                </MudButton>
            }
            else
            {
                <MudTextField @bind-Value="_confirmText" 
                              Label="Onaylamak için 'SİL' yazın" 
                              Variant="Variant.Outlined"
                              Class="mt-4" />
                
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Error" 
                           OnClick="ClearAllStudents"
                           Disabled="@(_confirmText != "SİL")"
                           FullWidth="true"
                           StartIcon="@Icons.Material.Filled.DeleteForever">
                    Tüm Öğrencileri Sil
                </MudButton>
            }
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private int _studentCount = 0;
    private int _graduateCount = 0;
    private int _transcriptCount = 0;
    private int _attendanceCount = 0;
    private int _paymentCount = 0;
    private string _confirmText = string.Empty;
    private bool _isClearing = false;
    private bool _isCleared = false;
    private bool _disposed = false;

    protected override async Task OnInitializedAsync()
    {
        if (_disposed) return;
        await LoadCounts();
    }

    private async Task LoadCounts()
    {
        if (_disposed) return;
        
        try
        {
            _studentCount = await DbContext.Students.CountAsync();
            _graduateCount = await DbContext.Students.CountAsync(s => s.MezunMu);
            _transcriptCount = await DbContext.TranscriptRecords.CountAsync();
            _attendanceCount = await DbContext.StudentMeetingAttendances.CountAsync();
            _paymentCount = await DbContext.ScholarshipPayments.CountAsync();
        }
        catch (ObjectDisposedException)
        {
            // Component disposed, ignore
        }
    }

    private async Task ClearAllStudents()
    {
        if (_disposed) return;
        
        if (_confirmText != "SİL")
        {
            if (!_disposed) Snackbar?.Add("Lütfen onaylamak için 'SİL' yazın", Severity.Warning);
            return;
        }

        _isClearing = true;
        if (!_disposed) StateHasChanged();

        try
        {
            if (_disposed) return;
            
            // İlişkili tabloları önce temizle (Foreign Key constraints için)
            await DbContext.Database.ExecuteSqlRawAsync("DELETE FROM TranscriptRecords");
            await DbContext.Database.ExecuteSqlRawAsync("DELETE FROM StudentMeetingAttendances");
            await DbContext.Database.ExecuteSqlRawAsync("DELETE FROM ScholarshipPayments");
            
            // Öğrencileri sil
            await DbContext.Database.ExecuteSqlRawAsync("DELETE FROM Students");
            
            // VACUUM işlemi (veritabanını optimize et)
            await DbContext.Database.ExecuteSqlRawAsync("VACUUM");
            
            if (_disposed) return;
            
            _isCleared = true;
            if (!_disposed) Snackbar?.Add("Tüm öğrenci kayıtları başarıyla silindi!", Severity.Success);
        }
        catch (ObjectDisposedException)
        {
            // Component disposed, ignore
        }
        catch (Exception ex)
        {
            if (!_disposed) Snackbar?.Add($"Hata: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isClearing = false;
            if (!_disposed)
            {
                await LoadCounts();
                StateHasChanged();
            }
        }
    }

    public void Dispose()
    {
        _disposed = true;
    }
}
