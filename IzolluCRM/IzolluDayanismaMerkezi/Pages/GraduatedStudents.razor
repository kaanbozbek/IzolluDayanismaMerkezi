@page "/graduated-students"
@inject StudentService StudentService
@inject MemberService MemberService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>Mezun Öğrenciler - İzollu Dayanışma Merkezi</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Mezun Öğrenciler</MudText>

<MudTable Items="@_students" Dense="true" Hover="true" Loading="@_loading" Filter="new Func<Student, bool>(FilterFunc)">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Toplam: @_students.Count mezun</MudText>
        <MudSpacer />
        <MudTextField @bind-Value="_searchString" Placeholder="Ara..." Adornment="Adornment.Start" 
                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>Sicil No</MudTh>
        <MudTh>Adı Soyadı</MudTh>
        <MudTh>Meslek</MudTh>
        <MudTh>Firma</MudTh>
        <MudTh>Okul/Bölüm</MudTh>
        <MudTh>İletişim</MudTh>
        <MudTh>Mezuniyet Tarihi</MudTh>
        <MudTh>İşlemler</MudTh>
    </HeaderContent>
    <RowTemplate Context="student">
        <MudTd DataLabel="Sicil No">@(!string.IsNullOrWhiteSpace(student.SicilNumarasi) ? student.SicilNumarasi : "-")</MudTd>
        <MudTd DataLabel="Adı Soyadı">
            <MudLink OnClick="@(() => OpenDetailDialog(student))" Style="cursor: pointer;">
                <MudText Typo="Typo.body2"><b>@student.AdSoyad</b></MudText>
            </MudLink>
            @if (student.IsIzollulu)
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Primary" Icon="@Icons.Material.Filled.Home">İzollulu</MudChip>
            }
        </MudTd>
        <MudTd DataLabel="Meslek">
            @if (!string.IsNullOrEmpty(student.Meslek))
            {
                <MudText Typo="Typo.body2"><MudIcon Icon="@Icons.Material.Filled.Work" Size="Size.Small" /> @student.Meslek</MudText>
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
            }
        </MudTd>
        <MudTd DataLabel="Firma">
            @if (!string.IsNullOrEmpty(student.Firma))
            {
                <MudText Typo="Typo.body2"><MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" /> @student.Firma</MudText>
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
            }
        </MudTd>
        <MudTd DataLabel="Okul/Bölüm">
            @if (!string.IsNullOrEmpty(student.Universite))
            {
                <MudText Typo="Typo.body2"><MudIcon Icon="@Icons.Material.Filled.School" Size="Size.Small" /> @student.Universite</MudText>
            }
            @if (!string.IsNullOrEmpty(student.Bolum))
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary">@student.Bolum</MudText>
            }
            @if (string.IsNullOrEmpty(student.Universite))
            {
                <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
            }
        </MudTd>
        <MudTd DataLabel="İletişim">
            @if (!string.IsNullOrEmpty(student.Telefon))
            {
                <MudText Typo="Typo.body2"><MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" /> @student.Telefon</MudText>
            }
            @if (!string.IsNullOrEmpty(student.Email))
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary"><MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" /> @student.Email</MudText>
            }
            @if (string.IsNullOrEmpty(student.Telefon) && string.IsNullOrEmpty(student.Email))
            {
                <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
            }
        </MudTd>
        <MudTd DataLabel="Mezuniyet Tarihi">
            @if (student.MezuniyetTarihi.HasValue)
            {
                <MudChip T="string" Color="Color.Success" Size="Size.Small" Icon="@Icons.Material.Filled.School">
                    @student.MezuniyetTarihi.Value.ToString("dd/MM/yyyy")
                </MudChip>
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
            }
        </MudTd>
        <MudTd DataLabel="İşlemler">
            @if (_memberStudentIds.Contains(student.Id))
            {
                <MudChip T="string" Color="Color.Info" Size="Size.Small" Icon="@Icons.Material.Filled.CheckCircle">Üye</MudChip>
            }
            else
            {
                <MudButton Variant="Variant.Text" 
                           Color="Color.Primary" 
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.PersonAdd"
                           OnClick="@(() => ConvertToMemberAsync(student))">
                    Üye Olarak Ekle
                </MudButton>
            }
        </MudTd>
    </RowTemplate>
</MudTable>

@code {
    private List<Student> _students = new();
    private bool _loading = true;
    private string _searchString = "";
    private HashSet<int> _memberStudentIds = new();
    private bool _disposed = false;

    protected override async Task OnInitializedAsync()
    {
        if (_disposed) return;
        await LoadData();
    }

    private async Task LoadData()
    {
        if (_disposed) return;
        
        _loading = true;
        if (!_disposed) StateHasChanged();
        
        try
        {
            _students = await StudentService.GetGraduatedStudentsAsync();
            
            if (_disposed) return;
            
            // Load member IDs to check if student is already a member
            await LoadMemberStudentIds();
        }
        catch (ObjectDisposedException)
        {
            // Component disposed, ignore
        }
        finally
        {
            _loading = false;
            if (!_disposed) StateHasChanged();
        }
    }
    
    private async Task LoadMemberStudentIds()
    {
        var allMembers = await MemberService.GetAllAsync();
        var studentIds = _students.Select(s => s.Id).ToList();
        
        // Check if any graduated student has matching TC No, name, or other identifiers
        _memberStudentIds = allMembers
            .Where(m => _students.Any(s => 
                (!string.IsNullOrEmpty(m.TCNo) && !string.IsNullOrEmpty(s.TCNo) && m.TCNo == s.TCNo) ||
                (!string.IsNullOrEmpty(m.AdSoyad) && !string.IsNullOrEmpty(s.AdSoyad) && m.AdSoyad.Equals(s.AdSoyad, StringComparison.OrdinalIgnoreCase))
            ))
            .Select(m => _students.First(s => 
                (!string.IsNullOrEmpty(m.TCNo) && !string.IsNullOrEmpty(s.TCNo) && m.TCNo == s.TCNo) ||
                (!string.IsNullOrEmpty(m.AdSoyad) && !string.IsNullOrEmpty(s.AdSoyad) && m.AdSoyad.Equals(s.AdSoyad, StringComparison.OrdinalIgnoreCase))
            ).Id)
            .ToHashSet();
    }
    
    private async Task ConvertToMemberAsync(Student student)
    {
        if (_disposed) return;
        
        var confirm = await DialogService.ShowMessageBox(
            "Onay", 
            $"{student.AdSoyad} adlı mezun öğrenciyi üye olarak eklemek istediğinizden emin misiniz?",
            yesText: "Evet", cancelText: "Hayır");
        
        if (confirm != true) return;
        if (_disposed) return;
        
        try
        {
            // Create new member from student data
            var member = new Member
            {
                AdSoyad = student.AdSoyad,
                TCNo = student.TCNo,
                DogumTarihi = student.DogumTarihi,
                Yas = student.Yas,
                Telefon = student.Telefon,
                Email = student.Email,
                Adres = student.Adres,
                Koy = student.Koy,
                Meslek = student.Meslek,
                SicilNumarasi = student.SicilNumarasi,
                AktifMi = true,
                BursVeriyor = false,
                IsMutevelli = false,
                IsYonetimKurulu = false,
                IsDenetimKurulu = false,
                IsIzollulu = student.IsIzollulu,
                UyelikTuru = "Mezun Öğrenci",
                UyelikBaslangicTarihi = DateTime.Now,
                Notlar = $"Mezun öğrenciden dönüştürüldü. Mezuniyet Tarihi: {student.MezuniyetTarihi?.ToString("dd/MM/yyyy")}",
                OlusturmaTarihi = DateTime.Now
            };
            
            await MemberService.CreateAsync(member);
            
            if (_disposed) return;
            
            _memberStudentIds.Add(student.Id);
            
            if (!_disposed)
            {
                Snackbar?.Add($"{student.AdSoyad} başarıyla üye olarak eklendi.", Severity.Success);
                StateHasChanged();
            }
        }
        catch (ObjectDisposedException)
        {
            // Component disposed, ignore
        }
        catch (Exception ex)
        {
            if (!_disposed) Snackbar?.Add($"Hata: {ex.Message}", Severity.Error);
        }
    }

    public void Dispose()
    {
        _disposed = true;
    }

    private bool FilterFunc(Student student)
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;
        if (student.AdSoyad?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        if (student.Meslek?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        if (student.Firma?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        if (student.Universite?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        if (student.Bolum?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        if (student.Telefon?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        if (student.Email?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        if (student.SicilNumarasi?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        return false;
    }

    private async Task OpenDetailDialog(Student student)
    {
        var parameters = new DialogParameters { ["StudentId"] = student.Id };
        var options = new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true };
        await DialogService.ShowAsync<StudentDetailDialog>("Mezun Öğrenci Detayı", parameters, options);
    }
}
