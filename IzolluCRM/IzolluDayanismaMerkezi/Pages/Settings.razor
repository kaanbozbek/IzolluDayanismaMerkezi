@page "/settings"
@using IzolluVakfi.Data.Models
@inject SettingsService SettingsService
@inject SystemSettingsService SystemSettingsService
@inject TranscriptService TranscriptService
@inject MeetingService MeetingService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Ayarlar - İzollu Dayanışma Merkezi</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Ayarlar</MudText>

<MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Class="mt-4">
    <MudTabPanel Text="Kontroller">
        <MudCard Class="mt-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Transkript Kontrolü</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudText Typo="Typo.body2" Class="mb-4">
                    Bu kontrol, GNO'su 2.0'ın altında olan aktif burslu öğrencilerin burslarını keser ve gerekçe olarak "Transkript" notunu ekler.
                </MudText>
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Warning" 
                          StartIcon="@Icons.Material.Filled.Assignment"
                          OnClick="RunTranscriptCheck"
                          Disabled="_processingTranscript">
                    @if (_processingTranscript)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                        <span class="ms-2">İşleniyor...</span>
                    }
                    else
                    {
                        <span>Transkript Kontrolü Başlat</span>
                    }
                </MudButton>
            </MudCardContent>
        </MudCard>

        <MudCard Class="mt-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Toplantı Katılım Kontrolü</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudText Typo="Typo.body2" Class="mb-4">
                    Bu kontrol, en son toplantıya katılmayan aktif burslu öğrencilerin burslarını keser ve gerekçe olarak "Toplantıya katılmama" notunu ekler.
                </MudText>
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Warning" 
                          StartIcon="@Icons.Material.Filled.EventBusy"
                          OnClick="RunMeetingCheck"
                          Disabled="_processingMeeting">
                    @if (_processingMeeting)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                        <span class="ms-2">İşleniyor...</span>
                    }
                    else
                    {
                        <span>Toplantı Kontrolü Başlat</span>
                    }
                </MudButton>
            </MudCardContent>
        </MudCard>
    </MudTabPanel>

    <MudTabPanel Text="Sektörler">
        <MudCard Class="mt-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Sektör Listesi</MudText>
                </CardHeaderContent>
                <CardHeaderActions>
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Add"
                              OnClick="AddSektor">
                        Yeni Sektör Ekle
                    </MudButton>
                </CardHeaderActions>
            </MudCardHeader>
            <MudCardContent>
                <MudList T="string">
                    @foreach (var sektor in _sektorler)
                    {
                        <MudListItem T="string">
                            <div class="d-flex justify-space-between align-center">
                                <MudText>@sektor</MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                             Color="Color.Error" 
                                             Size="Size.Small"
                                             OnClick="() => DeleteSektor(sektor)" />
                            </div>
                        </MudListItem>
                        <MudDivider />
                    }
                </MudList>
            </MudCardContent>
        </MudCard>
    </MudTabPanel>

    <MudTabPanel Text="Üniversiteler">
        <MudCard Class="mt-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Üniversite Listesi</MudText>
                </CardHeaderContent>
                <CardHeaderActions>
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Add"
                              OnClick="AddUniversite">
                        Yeni Üniversite Ekle
                    </MudButton>
                </CardHeaderActions>
            </MudCardHeader>
            <MudCardContent>
                <MudList T="string">
                    @foreach (var uni in _universiteler)
                    {
                        <MudListItem T="string">
                            <div class="d-flex justify-space-between align-center">
                                <MudText>@uni</MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                             Color="Color.Error" 
                                             Size="Size.Small"
                                             OnClick="() => DeleteUniversite(uni)" />
                            </div>
                        </MudListItem>
                        <MudDivider />
                    }
                </MudList>
            </MudCardContent>
        </MudCard>
    </MudTabPanel>

    <MudTabPanel Text="Bölümler">
        <MudCard Class="mt-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Bölüm Listesi</MudText>
                </CardHeaderContent>
                <CardHeaderActions>
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Add"
                              OnClick="AddBolum">
                        Yeni Bölüm Ekle
                    </MudButton>
                </CardHeaderActions>
            </MudCardHeader>
            <MudCardContent>
                <MudList T="string">
                    @foreach (var bolum in _bolumler)
                    {
                        <MudListItem T="string">
                            <div class="d-flex justify-space-between align-center">
                                <MudText>@bolum</MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                             Color="Color.Error" 
                                             Size="Size.Small"
                                             OnClick="() => DeleteBolum(bolum)" />
                            </div>
                        </MudListItem>
                        <MudDivider />
                    }
                </MudList>
            </MudCardContent>
        </MudCard>
    </MudTabPanel>

    <MudTabPanel Text="Dönemler">
        <MudCard Class="mt-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Dönem Yönetimi</MudText>
                </CardHeaderContent>
                <CardHeaderActions>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddPeriodDialog">
                        Yeni Dönem Ekle
                    </MudButton>
                </CardHeaderActions>
            </MudCardHeader>
            <MudCardContent>
                <MudTable Items="@_periods" Hover="true" Dense="true">
                    <HeaderContent>
                        <MudTh>Dönem</MudTh>
                        <MudTh>İşlemler</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Dönem">@context</MudTd>
                        <MudTd DataLabel="İşlemler">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeletePeriod(context))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudCardContent>
        </MudCard>
    </MudTabPanel>

    <MudTabPanel Text="Burs Tutarları">
        <MudCard Class="mt-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Dönem Bazlı Burs Tutarları</MudText>
                </CardHeaderContent>
                <CardHeaderActions>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddScholarshipDialog">
                        Yeni Burs Tutarı Ekle
                    </MudButton>
                </CardHeaderActions>
            </MudCardHeader>
            <MudCardContent>
                <MudTable Items="@_scholarshipAmounts" Hover="true" Dense="true">
                    <HeaderContent>
                        <MudTh>Dönem</MudTh>
                        <MudTh>Aylık Burs Tutarı</MudTh>
                        <MudTh>Yıllık Tutar</MudTh>
                        <MudTh>İşlemler</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Dönem">@context.Period</MudTd>
                        <MudTd DataLabel="Aylık Burs Tutarı">@context.Amount.ToString("N2") ₺</MudTd>
                        <MudTd DataLabel="Yıllık Tutar">@((context.Amount * 12).ToString("N2")) ₺</MudTd>
                        <MudTd DataLabel="İşlemler">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" OnClick="@(() => OpenEditScholarshipDialog(context))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteScholarshipAmount(context))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudCardContent>
        </MudCard>
    </MudTabPanel>
</MudTabs>

@code {
    private List<string> _sektorler = new();
    private List<string> _universiteler = new();
    private List<string> _bolumler = new();
    private List<string> _periods = new();
    private List<ScholarshipAmountModel> _scholarshipAmounts = new();
    private bool _processingTranscript;
    private bool _processingMeeting;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        _sektorler = await SettingsService.GetListValueAsync("Sektorler");
        _universiteler = await SettingsService.GetListValueAsync("Universiteler");
        _bolumler = await SettingsService.GetListValueAsync("Bolumler");
        _periods = await SettingsService.GetListValueAsync("AcademicPeriods");
        
        // Load scholarship amounts
        var amountsJson = await SettingsService.GetValueAsync("ScholarshipAmountsByPeriod");
        if (!string.IsNullOrWhiteSpace(amountsJson))
        {
            try
            {
                _scholarshipAmounts = System.Text.Json.JsonSerializer.Deserialize<List<ScholarshipAmountModel>>(amountsJson) ?? new();
            }
            catch
            {
                _scholarshipAmounts = new();
            }
        }
    }

    private async Task OpenAddPeriodDialog()
    {
        var parameters = new DialogParameters<SimpleInputDialog>
        {
            { x => x.Title, "Yeni Dönem Ekle" },
            { x => x.Label, "Dönem (örn: 2025-2026)" }
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<SimpleInputDialog>("Yeni Dönem", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string newPeriod && !string.IsNullOrWhiteSpace(newPeriod))
        {
            if (!_periods.Contains(newPeriod))
            {
                _periods.Add(newPeriod);
                _periods = _periods.OrderByDescending(p => p).ToList();
                await SettingsService.SetListValueAsync("AcademicPeriods", _periods, "Akademik dönemler listesi");
                Snackbar.Add("Dönem eklendi", Severity.Success);
            }
            else
            {
                Snackbar.Add("Bu dönem zaten mevcut", Severity.Warning);
            }
        }
    }

    private async Task DeletePeriod(string period)
    {
        bool? result = await DialogService.ShowMessageBox("Uyarı", $"'{period}' dönemini silmek istediğinize emin misiniz?", yesText: "Sil", cancelText: "İptal");
        if (result == true)
        {
            _periods.Remove(period);
            await SettingsService.SetListValueAsync("AcademicPeriods", _periods, "Akademik dönemler listesi");
            Snackbar.Add("Dönem silindi", Severity.Info);
        }
    }

    private async Task OpenAddScholarshipDialog()
    {
        var parameters = new DialogParameters
        {
            ["Periods"] = _periods,
            ["IsEdit"] = false
        };
        var dialog = await DialogService.ShowAsync<ScholarshipAmountDialog>("Yeni Burs Tutarı Ekle", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is ScholarshipAmountModel newAmount)
        {
            var existing = _scholarshipAmounts.FirstOrDefault(x => x.Period == newAmount.Period);
            if (existing != null)
            {
                Snackbar.Add("Bu dönem için zaten bir tutar mevcut!", Severity.Warning);
                return;
            }
            
            _scholarshipAmounts.Add(newAmount);
            await SaveScholarshipAmounts();
            Snackbar.Add("Burs tutarı eklendi", Severity.Success);
        }
    }

    private async Task OpenEditScholarshipDialog(ScholarshipAmountModel amount)
    {
        var parameters = new DialogParameters
        {
            ["Periods"] = _periods,
            ["Amount"] = amount,
            ["IsEdit"] = true
        };
        var dialog = await DialogService.ShowAsync<ScholarshipAmountDialog>("Burs Tutarını Düzenle", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is ScholarshipAmountModel updatedAmount)
        {
            var existing = _scholarshipAmounts.FirstOrDefault(x => x.Period == amount.Period);
            if (existing != null)
            {
                existing.Amount = updatedAmount.Amount;
                await SaveScholarshipAmounts();
                Snackbar.Add("Burs tutarı güncellendi", Severity.Success);
            }
        }
    }

    private async Task DeleteScholarshipAmount(ScholarshipAmountModel amount)
    {
        bool? result = await DialogService.ShowMessageBox("Uyarı", $"'{amount.Period}' dönemi için burs tutarını silmek istediğinize emin misiniz?", yesText: "Sil", cancelText: "İptal");
        if (result == true)
        {
            _scholarshipAmounts.Remove(amount);
            await SaveScholarshipAmounts();
            Snackbar.Add("Burs tutarı silindi", Severity.Info);
        }
    }

    private async Task SaveScholarshipAmounts()
    {
        var json = System.Text.Json.JsonSerializer.Serialize(_scholarshipAmounts);
        await SettingsService.SetValueAsync("ScholarshipAmountsByPeriod", json, "Dönem bazlı burs tutarları");
    }

    private async Task AddSektor()
    {
        var parameters = new DialogParameters<SimpleInputDialog>
        {
            { x => x.Title, "Yeni Sektör Ekle" },
            { x => x.Label, "Sektör Adı" }
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<SimpleInputDialog>("Yeni Sektör", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string newSektor && !string.IsNullOrWhiteSpace(newSektor))
        {
            if (!_sektorler.Contains(newSektor))
            {
                _sektorler.Add(newSektor);
                await SettingsService.SetListValueAsync("Sektorler", _sektorler, "İş adamları için sektör listesi");
                Snackbar.Add("Sektör eklendi", Severity.Success);
            }
            else
            {
                Snackbar.Add("Bu sektör zaten mevcut", Severity.Warning);
            }
        }
    }

    private async Task DeleteSektor(string sektor)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Onayla",
            $"'{sektor}' sektörünü silmek istediğinizden emin misiniz?",
            yesText: "Sil", cancelText: "İptal");

        if (result == true)
        {
            _sektorler.Remove(sektor);
            await SettingsService.SetListValueAsync("Sektorler", _sektorler, "İş adamları için sektör listesi");
            Snackbar.Add("Sektör silindi", Severity.Success);
        }
    }

    private async Task AddUniversite()
    {
        var parameters = new DialogParameters<SimpleInputDialog>
        {
            { x => x.Title, "Yeni Üniversite Ekle" },
            { x => x.Label, "Üniversite Adı" }
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<SimpleInputDialog>("Yeni Üniversite", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string newUni && !string.IsNullOrWhiteSpace(newUni))
        {
            if (!_universiteler.Contains(newUni))
            {
                _universiteler.Add(newUni);
                await SettingsService.SetListValueAsync("Universiteler", _universiteler, "Öğrenciler için üniversite listesi");
                Snackbar.Add("Üniversite eklendi", Severity.Success);
            }
            else
            {
                Snackbar.Add("Bu üniversite zaten mevcut", Severity.Warning);
            }
        }
    }

    private async Task DeleteUniversite(string uni)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Onayla",
            $"'{uni}' üniversitesini silmek istediğinizden emin misiniz?",
            yesText: "Sil", cancelText: "İptal");

        if (result == true)
        {
            _universiteler.Remove(uni);
            await SettingsService.SetListValueAsync("Universiteler", _universiteler, "Öğrenciler için üniversite listesi");
            Snackbar.Add("Üniversite silindi", Severity.Success);
        }
    }

    private async Task AddBolum()
    {
        var parameters = new DialogParameters<SimpleInputDialog>
        {
            { x => x.Title, "Yeni Bölüm Ekle" },
            { x => x.Label, "Bölüm Adı" }
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<SimpleInputDialog>("Yeni Bölüm", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string newBolum && !string.IsNullOrWhiteSpace(newBolum))
        {
            if (!_bolumler.Contains(newBolum))
            {
                _bolumler.Add(newBolum);
                await SettingsService.SetListValueAsync("Bolumler", _bolumler, "Öğrenciler için bölüm listesi");
                Snackbar.Add("Bölüm eklendi", Severity.Success);
            }
            else
            {
                Snackbar.Add("Bu bölüm zaten mevcut", Severity.Warning);
            }
        }
    }

    private async Task DeleteBolum(string bolum)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Onayla",
            $"'{bolum}' bölümünü silmek istediğinizden emin misiniz?",
            yesText: "Sil", cancelText: "İptal");

        if (result == true)
        {
            _bolumler.Remove(bolum);
            await SettingsService.SetListValueAsync("Bolumler", _bolumler, "Öğrenciler için bölüm listesi");
            Snackbar.Add("Bölüm silindi", Severity.Success);
        }
    }

    private async Task RunTranscriptCheck()
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Transkript Kontrolü",
            "Bu işlem GNO'su 2.0'ın altında olan tüm aktif burslu öğrencilerin burslarını kesecektir. Devam etmek istiyor musunuz?",
            yesText: "Evet, Başlat", cancelText: "İptal");

        if (confirm != true)
            return;

        _processingTranscript = true;
        try
        {
            var affectedCount = await TranscriptService.CheckAndUpdateScholarshipsAsync();
            Snackbar.Add($"Transkript kontrolü tamamlandı. {affectedCount} öğrencinin bursu kesildi.", 
                affectedCount > 0 ? Severity.Warning : Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processingTranscript = false;
        }
    }

    private async Task RunMeetingCheck()
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Toplantı Katılım Kontrolü",
            "Bu işlem en son toplantıya katılmayan tüm aktif burslu öğrencilerin burslarını kesecektir. Devam etmek istiyor musunuz?",
            yesText: "Evet, Başlat", cancelText: "İptal");

        if (confirm != true)
            return;

        _processingMeeting = true;
        try
        {
            var affectedCount = await MeetingService.ApplyLatestMeetingAbsencePenaltyAsync();
            Snackbar.Add($"Toplantı kontrolü tamamlandı. {affectedCount} öğrencinin bursu kesildi.", 
                affectedCount > 0 ? Severity.Warning : Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processingMeeting = false;
        }
    }
}
