@page "/scholarship-students"
@inject StudentService StudentService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Burs Alan Öğrenciler - İzollu Dayanışma Merkezi</PageTitle>

<MudText Typo="Typo.h5" Class="mb-4"><b>Burs Alan Öğrenciler</b></MudText>

<MudPaper Elevation="0" Class="pa-4 border rounded-lg">
    <MudTable Items="@_students" Dense="true" Hover="true" Loading="@_loading" Filter="new Func<Student, bool>(FilterFunc)" Elevation="0" Outlined="true" Bordered="true">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Toplam: @_students.Count Öğrenci</MudText>
            <MudSpacer />
            <MudTextField @bind-Value="_searchString" Placeholder="Ara..." Adornment="Adornment.Start" 
                          AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" Variant="Variant.Outlined" Margin="Margin.Dense"></MudTextField>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>Sicil No</MudTh>
            <MudTh>Adı Soyadı</MudTh>
            <MudTh>Mesleği</MudTh>
            <MudTh>Okulu</MudTh>
            <MudTh>Yaşı</MudTh>
            <MudTh>Cinsiyeti</MudTh>
            <MudTh>Adresi</MudTh>
            <MudTh>Burs Durumu</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Sicil No">@(!string.IsNullOrWhiteSpace(context.SicilNumarasi) ? context.SicilNumarasi : "-")</MudTd>
            <MudTd DataLabel="Adı Soyadı">
                <MudLink OnClick="@(() => OpenDetailDialog(context))">@context.AdSoyad</MudLink>
            </MudTd>
            <MudTd DataLabel="Mesleği">@context.Meslek</MudTd>
            <MudTd DataLabel="Okulu">@context.Universite</MudTd>
            <MudTd DataLabel="Yaşı">@(context.Yas?.ToString() ?? "-")</MudTd>
            <MudTd DataLabel="Cinsiyeti">@(string.IsNullOrWhiteSpace(context.Cinsiyet) ? "-" : context.Cinsiyet)</MudTd>
            <MudTd DataLabel="Adresi">@(context.Adres?.Length > 30 ? context.Adres.Substring(0, 30) + "..." : context.Adres)</MudTd>
            <MudTd DataLabel="Burs Durumu">
                <MudChip T="string" Color="@(context.AktifBursMu ? Color.Success : Color.Error)" Size="Size.Small">
                    @(context.AktifBursMu ? "Burs Alıyor" : "Burs Almıyor")
                </MudChip>
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudPaper>

@code {
    private List<Student> _students = new();
    private bool _loading = true;
    private string _searchString = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        
        // Load all active scholarship students
        _students = await StudentService.GetActiveScholarshipStudentsAsync();
        
        _loading = false;
    }

    private bool FilterFunc(Student student)
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;
        if (student.AdSoyad.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (student.Universite?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        if (student.Cinsiyet?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        return false;
    }

    private async Task OpenDetailDialog(Student student)
    {
        var parameters = new DialogParameters 
        { 
            ["StudentId"] = student.Id,
            ["ShowGraduateButton"] = true
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ScholarshipStudentDetailDialog>("Öğrenci Detayı", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            Snackbar.Add("İşlem başarıyla tamamlandı.", Severity.Success);
        }
    }
}
