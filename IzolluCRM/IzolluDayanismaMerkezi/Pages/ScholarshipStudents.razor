@page "/scholarship-students"
@inject StudentService StudentService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Burs Alan ��renciler - �zollu Dayan��ma Merkezi</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Burs Alan ��renciler</MudText>

<MudTable Items="@_students" Dense="true" Hover="true" Loading="@_loading" Filter="new Func<Student, bool>(FilterFunc)">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Toplam: @_students.Count ��renci</MudText>
        <MudSpacer />
        <MudTextField @bind-Value="_searchString" Placeholder="Ara..." Adornment="Adornment.Start" 
                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>Sicil No</MudTh>
        <MudTh>Ad� Soyad�</MudTh>
        <MudTh>Mesle�i</MudTh>
        <MudTh>Okulu</MudTh>
        <MudTh>Ya��</MudTh>
        <MudTh>Cinsiyeti</MudTh>
        <MudTh>Adresi</MudTh>
        <MudTh>Burs Durumu</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Sicil No">@(!string.IsNullOrWhiteSpace(context.SicilNumarasi) ? context.SicilNumarasi : "-")</MudTd>
        <MudTd DataLabel="Ad� Soyad�">
            <MudLink OnClick="@(() => OpenDetailDialog(context))">@context.AdSoyad</MudLink>
        </MudTd>
        <MudTd DataLabel="Mesle�i">@context.Meslek</MudTd>
        <MudTd DataLabel="Okulu">@context.Universite</MudTd>
        <MudTd DataLabel="Ya��">@(context.Yas?.ToString() ?? "-")</MudTd>
        <MudTd DataLabel="Cinsiyeti">@(string.IsNullOrWhiteSpace(context.Cinsiyet) ? "-" : context.Cinsiyet)</MudTd>
        <MudTd DataLabel="Adresi">@(context.Adres?.Length > 30 ? context.Adres.Substring(0, 30) + "..." : context.Adres)</MudTd>
        <MudTd DataLabel="Burs Durumu">
            <MudChip T="string" Color="@(context.AktifBursMu ? Color.Success : Color.Error)" Size="Size.Small">
                @(context.AktifBursMu ? "Burs Al�yor" : "Burs Alm�yor")
            </MudChip>
        </MudTd>
    </RowTemplate>
</MudTable>

@code {
    private List<Student> _students = new();
    private bool _loading = true;
    private string _searchString = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        
        // Load all active scholarship students
        _students = await StudentService.GetActiveScholarshipStudentsAsync();
        
        _loading = false;
    }

    private bool FilterFunc(Student student)
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;
        if (student.AdSoyad.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (student.Universite?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        if (student.Cinsiyet?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        return false;
    }

    private async Task OpenDetailDialog(Student student)
    {
        var parameters = new DialogParameters 
        { 
            ["StudentId"] = student.Id,
            ["ShowGraduateButton"] = true
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ScholarshipStudentDetailDialog>("��renci Detay�", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            Snackbar.Add("��lem ba�ar�yla tamamland�.", Severity.Success);
        }
    }

}
}
