@page "/meetings"
@using IzolluVakfi.Data.Entities
@inject MeetingService MeetingService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime

<PageTitle>Toplantılar - İzollu Dayanışma Merkezi</PageTitle>

@* STATISTICS CARDS *@
<MudGrid Class="mb-4" Spacing="3">
    <MudItem xs="12" sm="3">
        <MudPaper Elevation="2" Class="pa-4" Style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 12px;">
            <div class="d-flex align-center justify-space-between">
                <div>
                    <MudText Typo="Typo.h5" Style="font-weight: bold;">@TotalMeetings</MudText>
                    <MudText Typo="Typo.body2" Style="opacity: 0.9;">Toplam Toplantı</MudText>
                </div>
                <MudIcon Icon="@Icons.Material.Outlined.Event" Size="Size.Large" Style="opacity: 0.8;" />
            </div>
        </MudPaper>
    </MudItem>
    
    <MudItem xs="12" sm="3">
        <MudPaper Elevation="2" Class="pa-4" Style="background: linear-gradient(135deg, #d97706 0%, #b45309 100%); color: white; border-radius: 12px;">
            <div class="d-flex align-center justify-space-between">
                <div>
                    <MudText Typo="Typo.h5" Style="font-weight: bold;">@ThisMonthMeetings</MudText>
                    <MudText Typo="Typo.body2" Style="opacity: 0.9;">Bu Ay</MudText>
                </div>
                <MudIcon Icon="@Icons.Material.Outlined.CalendarMonth" Size="Size.Large" Style="opacity: 0.8;" />
            </div>
        </MudPaper>
    </MudItem>
    
    <MudItem xs="12" sm="3">
        <MudPaper Elevation="2" Class="pa-4" Style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; border-radius: 12px;">
            <div class="d-flex align-center justify-space-between">
                <div>
                    <MudText Typo="Typo.h5" Style="font-weight: bold;">@UpcomingMeetings</MudText>
                    <MudText Typo="Typo.body2" Style="opacity: 0.9;">Yaklaşan Toplantı</MudText>
                </div>
                <MudIcon Icon="@Icons.Material.Outlined.Upcoming" Size="Size.Large" Style="opacity: 0.8;" />
            </div>
        </MudPaper>
    </MudItem>
    
    <MudItem xs="12" sm="3">
        <MudPaper Elevation="2" Class="pa-4" Style="background: linear-gradient(135deg, #78350f 0%, #92400e 100%); color: white; border-radius: 12px;">
            <div class="d-flex align-center justify-space-between">
                <div>
                    <MudText Typo="Typo.h5" Style="font-weight: bold;">@AverageAttendance%</MudText>
                    <MudText Typo="Typo.body2" Style="opacity: 0.9;">Ortalama Katılım</MudText>
                </div>
                <MudIcon Icon="@Icons.Material.Outlined.People" Size="Size.Large" Style="opacity: 0.8;" />
            </div>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudPaper Elevation="2" Class="pa-4">
    <div Class="d-flex gap-2 mb-4">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddDialog">
            Yeni Toplantı Ekle
        </MudButton>
    </div>

    @* FILTER BAR *@
    <MudPaper Class="pa-3 mb-3" Elevation="1">
        <div class="d-flex align-center gap-3">
            <MudTextField @bind-Value="_filters.SearchText"
                          Label="Ara"
                          Placeholder="Toplantı adı, konum, not..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true"
                          DebounceInterval="300"
                          OnDebounceIntervalElapsed="ApplyFilters"
                          Style="flex: 1; max-width: 400px;" />

            <MudButton Variant="Variant.Outlined"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Tune"
                       OnClick="@(() => _filterDrawerOpen = true)">
                Filtreler
            </MudButton>

            <MudButton Variant="Variant.Text"
                       Color="Color.Default"
                       OnClick="ClearAllFilters">
                TEMİZLE
            </MudButton>
        </div>
    </MudPaper>

    @* SELECTED FILTER CHIPS *@
    @if (_filters.HasAnyFilter())
    {
        <MudPaper Class="pa-3 mb-3" Elevation="0" Style="background-color: #f5f5f5;">
            <MudText Typo="Typo.body2" Class="mb-2"><strong>Seçilen Filtreler:</strong></MudText>
            <div class="d-flex flex-wrap gap-2">
                @if (!string.IsNullOrWhiteSpace(_filters.SearchText))
                {
                    <MudChip T="string" Color="Color.Primary" Size="Size.Small" OnClose="@(() => RemoveSearchFilter())">
                        Arama: @_filters.SearchText
                    </MudChip>
                }
                @if (!string.IsNullOrEmpty(_filters.SelectedMeetingType))
                {
                    <MudChip T="string" Color="Color.Info" Size="Size.Small" OnClose="@(() => RemoveMeetingTypeFilter())">
                        Tür: @_filters.SelectedMeetingType
                    </MudChip>
                }
                @if (!string.IsNullOrEmpty(_filters.SelectedLocation))
                {
                    <MudChip T="string" Color="Color.Secondary" Size="Size.Small" OnClose="@(() => RemoveLocationFilter())">
                        Konum: @_filters.SelectedLocation
                    </MudChip>
                }
                @if (_filters.DateFrom.HasValue || _filters.DateTo.HasValue)
                {
                    <MudChip T="string" Color="Color.Warning" Size="Size.Small" OnClose="@(() => RemoveDateFilter())">
                        Tarih: @(_filters.DateFrom?.ToString("dd.MM.yyyy") ?? "...") - @(_filters.DateTo?.ToString("dd.MM.yyyy") ?? "...")
                    </MudChip>
                }
            </div>
        </MudPaper>
    }

    @* MEETINGS TABLE *@
    <MudTable Items="@_filteredMeetings" Dense="true" Hover="true" Loading="@_loading"
              @bind-SelectedItem="_selectedMeeting" SortLabel="Sırala" RowsPerPage="50">
        <HeaderContent>
            <MudTh><MudTableSortLabel SortBy="new Func<Meeting, object>(x => x.Baslik)">Toplantı Adı</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<Meeting, object>(x => x.ToplantiTuru ?? string.Empty)">Türü</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<Meeting, object>(x => x.Tarih)">Tarih</MudTableSortLabel></MudTh>
            <MudTh>Saat</MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<Meeting, object>(x => x.Konum ?? string.Empty)">Konum</MudTableSortLabel></MudTh>
            <MudTh>Katılım</MudTh>
            <MudTh>İşlemler</MudTh>
        </HeaderContent>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 50, 100, 200 }" />
        </PagerContent>
        <RowTemplate>
            <MudTd DataLabel="Toplantı Adı">
                <MudLink OnClick="@(() => OpenDetailDialog(context))">@context.Baslik</MudLink>
            </MudTd>
            <MudTd DataLabel="Türü">
                <MudChip T="string" Size="Size.Small" Color="@GetMeetingTypeColor(context.ToplantiTuru)">
                    @context.ToplantiTuru
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Tarih">@context.Tarih.ToString("dd.MM.yyyy")</MudTd>
            <MudTd DataLabel="Saat">@context.Tarih.ToString("HH:mm") - @context.BitisTarihi.ToString("HH:mm")</MudTd>
            <MudTd DataLabel="Konum">
                @if (!string.IsNullOrEmpty(context.Konum))
                {
                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                    @context.Konum
                }
                else
                {
                    <span>-</span>
                }
            </MudTd>
            <MudTd DataLabel="Katılım">
                @{
                    var (attended, total) = GetAttendanceCounts(context);
                    var percentage = total > 0 ? (attended * 100 / total) : 0;
                    var color = percentage >= 75 ? Color.Success : (percentage >= 50 ? Color.Warning : Color.Error);
                }
                <MudChip T="string" Size="Size.Small" Color="@color">
                    @attended / @total (@percentage%)
                </MudChip>
            </MudTd>
            <MudTd DataLabel="İşlemler">
                <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" OnClick="@(() => OpenDetailDialog(context))" />
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => OpenEditDialog(context))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteMeeting(context.Id))" />
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudPaper>

@* FILTER DRAWER *@
<MudDrawer @bind-Open="_filterDrawerOpen" Anchor="Anchor.End" Elevation="2" Width="400px" Variant="@DrawerVariant.Temporary">
    <MudDrawerHeader>
        <MudText Typo="Typo.h6">Filtreler</MudText>
    </MudDrawerHeader>
    <MudDrawerContainer Class="pa-4" Style="overflow-y: auto;">
        <MudStack Spacing="4">
            
            @* Toplantı Türü *@
            <div>
                <MudText Typo="Typo.subtitle2" Class="mb-2"><strong>Toplantı Türü</strong></MudText>
                <MudRadioGroup @bind-Value="_filters.SelectedMeetingType">
                    <MudRadio Value="@("")" Color="Color.Primary">Tümü</MudRadio>
                    @foreach (var type in _meetingTypes)
                    {
                        <MudRadio Value="@type" Color="Color.Primary">@type</MudRadio>
                    }
                </MudRadioGroup>
            </div>

            @* Konum *@
            <div>
                <MudText Typo="Typo.subtitle2" Class="mb-2"><strong>Konum</strong></MudText>
                <MudRadioGroup @bind-Value="_filters.SelectedLocation">
                    <MudRadio Value="@("")" Color="Color.Primary">Tümü</MudRadio>
                    @foreach (var loc in _locations)
                    {
                        <MudRadio Value="@loc" Color="Color.Primary">@loc</MudRadio>
                    }
                </MudRadioGroup>
            </div>

            @* Tarih Aralığı *@
            <div>
                <MudText Typo="Typo.subtitle2" Class="mb-2"><strong>Tarih Aralığı</strong></MudText>
                <MudDatePicker @bind-Date="_filters.DateFrom" 
                               Label="Başlangıç Tarihi" 
                               Variant="Variant.Outlined"
                               DateFormat="dd.MM.yyyy" />
                <MudDatePicker @bind-Date="_filters.DateTo" 
                               Label="Bitiş Tarihi" 
                               Variant="Variant.Outlined"
                               DateFormat="dd.MM.yyyy"
                               Class="mt-2" />
            </div>

        </MudStack>
        
        <div Class="pa-4 mt-4">
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       FullWidth="true"
                       OnClick="ApplyFiltersAndClose">
                Filtreleri Uygula
            </MudButton>
        </div>
    </MudDrawerContainer>
</MudDrawer>

@code {
    // Constants
    private readonly string[] _meetingTypes = new[]
    {
        "Yönetim Kurulu",
        "Kurucular Heyeti",
        "Burs Komitesi",
        "Genel Toplantı"
    };

    private readonly string[] _locations = new[]
    {
        "Online – Zoom",
        "Online – Teams",
        "Merkez Ofis",
        "Dernek Salonu"
    };

    // State
    private MeetingFilterModel _filters = new();
    private List<Meeting> _allMeetings = new();
    private List<Meeting> _filteredMeetings = new();
    private Meeting? _selectedMeeting;
    private bool _loading = false;
    private bool _filterDrawerOpen = false;

    // Statistics Properties
    private int TotalMeetings => _allMeetings.Count;
    private int ThisMonthMeetings => _allMeetings.Count(m => m.Tarih.Month == DateTime.Now.Month && m.Tarih.Year == DateTime.Now.Year);
    private int UpcomingMeetings => _allMeetings.Count(m => m.Tarih >= DateTime.Today);
    private int AverageAttendance
    {
        get
        {
            if (!_allMeetings.Any()) return 0;
            var totalPercentage = 0;
            var count = 0;
            foreach (var meeting in _allMeetings)
            {
                var (attended, total) = GetAttendanceCounts(meeting);
                if (total > 0)
                {
                    totalPercentage += attended * 100 / total;
                    count++;
                }
            }
            return count > 0 ? totalPercentage / count : 0;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;

        try
        {
            _allMeetings = await MeetingService.GetAllAsync();
            _allMeetings = _allMeetings.OrderByDescending(m => m.Tarih).ToList();
            await ApplyFilters();
        }
        finally
        {
            _loading = false;
        }
    }

    private (int attended, int total) GetAttendanceCounts(Meeting meeting)
    {
        if (meeting.ToplantiTuru == "Yönetim Kurulu" || meeting.ToplantiTuru == "Kurucular Heyeti")
        {
            var memberAttendances = (meeting.MemberAttendances ?? Enumerable.Empty<MemberMeetingAttendance>())
                .Where(a => a.Member != null).ToList();
            return (memberAttendances.Count(a => a.Status == AttendanceStatus.Attended), memberAttendances.Count);
        }
        else
        {
            var attendances = (meeting.Attendances ?? Enumerable.Empty<StudentMeetingAttendance>())
                .Where(a => a.Student != null).ToList();
            return (attendances.Count(a => a.Status == AttendanceStatus.Attended), attendances.Count);
        }
    }

    private Color GetMeetingTypeColor(string? meetingType) => meetingType switch
    {
        "Yönetim Kurulu" => Color.Primary,
        "Kurucular Heyeti" => Color.Secondary,
        "Burs Komitesi" => Color.Info,
        "Genel Toplantı" => Color.Success,
        _ => Color.Default
    };

    // FILTERING LOGIC
    private async Task ApplyFilters()
    {
        await Task.Run(() =>
        {
            IEnumerable<Meeting> query = _allMeetings;

            // Search text
            if (!string.IsNullOrWhiteSpace(_filters.SearchText))
            {
                var searchLower = _filters.SearchText.Trim().ToLower();
                query = query.Where(m =>
                    (m.Baslik?.ToLower().Contains(searchLower) ?? false) ||
                    (m.Konum?.ToLower().Contains(searchLower) ?? false) ||
                    (m.Aciklama?.ToLower().Contains(searchLower) ?? false) ||
                    m.Tarih.ToString("dd.MM.yyyy").Contains(searchLower));
            }

            // Meeting type
            if (!string.IsNullOrEmpty(_filters.SelectedMeetingType))
                query = query.Where(m => m.ToplantiTuru == _filters.SelectedMeetingType);

            // Location
            if (!string.IsNullOrEmpty(_filters.SelectedLocation))
                query = query.Where(m => m.Konum == _filters.SelectedLocation);

            // Date range
            if (_filters.DateFrom.HasValue)
                query = query.Where(m => m.Tarih.Date >= _filters.DateFrom.Value.Date);

            if (_filters.DateTo.HasValue)
                query = query.Where(m => m.Tarih.Date <= _filters.DateTo.Value.Date);

            _filteredMeetings = query.ToList();
        });

        StateHasChanged();
    }

    private async Task ApplyFiltersAndClose()
    {
        _filterDrawerOpen = false;
        await ApplyFilters();
    }

    private async Task ClearAllFilters()
    {
        _filters.Clear();
        await ApplyFilters();
    }

    // FILTER CHIP REMOVAL METHODS
    private async Task RemoveSearchFilter()
    {
        _filters.SearchText = null;
        await ApplyFilters();
    }

    private async Task RemoveMeetingTypeFilter()
    {
        _filters.SelectedMeetingType = string.Empty;
        await ApplyFilters();
    }

    private async Task RemoveLocationFilter()
    {
        _filters.SelectedLocation = string.Empty;
        await ApplyFilters();
    }

    private async Task RemoveDateFilter()
    {
        _filters.DateFrom = null;
        _filters.DateTo = null;
        await ApplyFilters();
    }

    // DIALOG METHODS
    private async Task OpenAddDialog()
    {
        var parameters = new DialogParameters { ["IsEdit"] = false };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<MeetingDialog>("Yeni Toplantı Ekle", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadData();
            Snackbar.Add("Toplantı başarıyla eklendi.", Severity.Success);
        }
    }

    private async Task OpenEditDialog(Meeting meeting)
    {
        var parameters = new DialogParameters 
        { 
            ["IsEdit"] = true,
            ["Meeting"] = meeting
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<MeetingDialog>("Toplantı Düzenle", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadData();
            Snackbar.Add("Toplantı başarıyla güncellendi.", Severity.Success);
        }
    }

    private async Task OpenDetailDialog(Meeting meeting)
    {
        var (attended, total) = GetAttendanceCounts(meeting);
        var parameters = new DialogParameters<MeetingDetailDialog>
        {
            { x => x.Meeting, meeting },
            { x => x.AttendedCount, attended },
            { x => x.TotalCount, total }
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        await DialogService.ShowAsync<MeetingDetailDialog>("Toplantı Detayları", parameters, options);
    }

    private async Task DeleteMeeting(int meetingId)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Onayla",
            "Bu toplantıyı silmek istediğinizden emin misiniz?",
            yesText: "Sil", cancelText: "İptal");

        if (result == true)
        {
            await MeetingService.DeleteAsync(meetingId);
            await LoadData();
            Snackbar.Add("Toplantı silindi.", Severity.Info);
        }
    }

    // Filter Model
    private class MeetingFilterModel
    {
        public string? SearchText { get; set; }
        public string SelectedMeetingType { get; set; } = string.Empty;
        public string SelectedLocation { get; set; } = string.Empty;
        public DateTime? DateFrom { get; set; }
        public DateTime? DateTo { get; set; }

        public bool HasAnyFilter()
        {
            return !string.IsNullOrWhiteSpace(SearchText) ||
                   !string.IsNullOrEmpty(SelectedMeetingType) ||
                   !string.IsNullOrEmpty(SelectedLocation) ||
                   DateFrom.HasValue ||
                   DateTo.HasValue;
        }

        public void Clear()
        {
            SearchText = null;
            SelectedMeetingType = string.Empty;
            SelectedLocation = string.Empty;
            DateFrom = null;
            DateTo = null;
        }
    }
}
