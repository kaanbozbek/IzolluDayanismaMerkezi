@page "/activity-logs"
@inject ActivityLogService LogService

<PageTitle>Aktivite Logları - İzollu Dayanışma Merkezi</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudCard Class="mb-4">
    <MudCardContent>
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudDateRangePicker @bind-DateRange="_dateRange" Label="Tarih Aralığı" />
            </MudItem>
            <MudItem xs="12" md="4">
                <MudSelect @bind-Value="_selectedType" Label="İşlem Tipi" T="string" Variant="Variant.Outlined">
                    <MudSelectItem T="string" Value="@("Tümü")">Tümü</MudSelectItem>
                    <MudSelectItem T="string" Value="@("OgrenciEkle")">Öğrenci Ekle</MudSelectItem>
                    <MudSelectItem T="string" Value="@("OgrenciGuncelle")">Öğrenci Güncelle</MudSelectItem>
                    <MudSelectItem T="string" Value="@("OgrenciSil")">Öğrenci Sil</MudSelectItem>
                    <MudSelectItem T="string" Value="@("OgrenciMezun")">Öğrenci Mezun</MudSelectItem>
                    <MudSelectItem T="string" Value="@("BursKesildi")">Burs Kesildi</MudSelectItem>
                    <MudSelectItem T="string" Value="@("IsAdamiEkle")">İş Adamı Ekle</MudSelectItem>
                    <MudSelectItem T="string" Value="@("DonemAc")">Dönem Aç</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="FilterLogs" FullWidth="true">
                    Filtrele
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudCardContent>
</MudCard>

<MudTable Items="@_logs" Dense="true" Hover="true" Loading="@_loading">
    <HeaderContent>
        <MudTh>Tarih</MudTh>
        <MudTh>Kullanıcı</MudTh>
        <MudTh>İşlem Tipi</MudTh>
        <MudTh>Detay</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Tarih">@context.Tarih.ToString("dd.MM.yyyy HH:mm:ss")</MudTd>
        <MudTd DataLabel="Kullanıcı">
            <MudChip T="string" Size="Size.Small">@context.KullaniciAdi</MudChip>
        </MudTd>
        <MudTd DataLabel="İşlem Tipi">
            <MudChip T="string" Size="Size.Small" Color="@GetChipColor(context.IslemTipi)">@context.IslemTipi</MudChip>
        </MudTd>
        <MudTd DataLabel="Detay">@context.Detay</MudTd>
    </RowTemplate>
</MudTable>
</MudContainer>

@code {
    private List<ActivityLog> _logs = new();
    private bool _loading = true;
    private DateRange? _dateRange;
    private string _selectedType = "Tümü";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        _logs = await LogService.GetAllAsync();
        _loading = false;
    }

    private async Task FilterLogs()
    {
        _loading = true;

        if (_dateRange?.Start != null && _dateRange?.End != null)
        {
            _logs = await LogService.GetByDateRangeAsync(_dateRange.Start.Value, _dateRange.End.Value);
        }
        else
        {
            _logs = await LogService.GetAllAsync();
        }

        if (_selectedType != "Tümü")
        {
            _logs = _logs.Where(l => l.IslemTipi == _selectedType).ToList();
        }

        _loading = false;
    }

    private Color GetChipColor(string islemTipi)
    {
        return islemTipi switch
        {
            "OgrenciEkle" or "IsAdamiEkle" or "UyeEkle" or "DonemAc" => Color.Success,
            "OgrenciSil" or "IsAdamiSil" or "UyeSil" or "BursKesildi" => Color.Error,
            "OgrenciMezun" => Color.Info,
            "OgrenciGuncelle" or "IsAdamiGuncelle" or "UyeGuncelle" => Color.Warning,
            _ => Color.Default
        };
    }
}