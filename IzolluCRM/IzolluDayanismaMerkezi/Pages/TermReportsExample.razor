@*
EXAMPLE PAGE - DISABLED FOR NOW
This page demonstrates term-based reporting but requires additional DTOs
that are not yet implemented. Uncomment when TermReportService is fully implemented.
*@

@*@page "/term-reports"*@
@using IzolluVakfi.Services
@using IzolluVakfi.Data.Entities
@inject TermService TermService
@inject TermReportService TermReportService
@inject TermChangeNotifier TermChangeNotifier
@implements IDisposable

<PageTitle>Dönem Raporları</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Dönem Bazlı Raporlar</MudText>
    <MudText Typo="Typo.body2" Class="mb-4">
        Seçilen döneme ait tüm veriler snapshot modelinden gelir. Her dönem için bağımsız veriler saklanır.
    </MudText>

    @* Term Selector *@
    <MudPaper Class="pa-4 mb-4">
        <MudSelect T="int" 
                   Label="Dönem Seçin" 
                   Value="_selectedTermId ?? 0"
                   ValueChanged="OnTermSelectedAsync"
                   Variant="Variant.Outlined">
            @foreach (var term in _terms)
            {
                <MudSelectItem Value="@term.Id">
                    @term.DisplayName @(term.IsActive ? " ★ (Aktif)" : "")
                </MudSelectItem>
            }
        </MudSelect>
    </MudPaper>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Class="mb-4" />
    }
    else if (_selectedTermId.HasValue && _summary != null)
    {
        @* Dashboard Summary Cards *@
        <MudGrid Class="mb-4">
            <MudItem xs="12" sm="6" md="3">
                <MudCard>
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Aktif Burslu Öğrenci</MudText>
                        <MudText Typo="Typo.h3" Color="Color.Primary">@_summary.ActiveScholarshipStudents</MudText>
                        <MudText Typo="Typo.body2">@_summary.TermName dönemi</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudCard>
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Mezun Öğrenci</MudText>
                        <MudText Typo="Typo.h3" Color="Color.Success">@_summary.GraduatedStudents</MudText>
                        <MudText Typo="Typo.body2">Bu dönemde mezun olan</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudCard>
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Aylık Bütçe</MudText>
                        <MudText Typo="Typo.h3" Color="Color.Warning">@_summary.MonthlyScholarshipBudget.ToString("N0") ₺</MudText>
                        <MudText Typo="Typo.body2">Toplam aylık burs</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudCard>
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Yönetim Kurulu</MudText>
                        <MudText Typo="Typo.h3" Color="Color.Info">@_summary.ExecutiveBoardMembers</MudText>
                        <MudText Typo="Typo.body2">Aktif yönetim kurulu üyesi</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        @* Tabs for Different Reports *@
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Class="mt-4">
            <MudTabPanel Text="Burslu Öğrenciler">
                <MudTable Items="_activeStudents" Dense="true" Hover="true" Class="mt-2">
                    <HeaderContent>
                        <MudTh>Öğrenci Adı</MudTh>
                        <MudTh>Üniversite</MudTh>
                        <MudTh>Bölüm</MudTh>
                        <MudTh>Sınıf</MudTh>
                        <MudTh>Aylık Burs</MudTh>
                        <MudTh>Bağışçı</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Öğrenci">@context.StudentName</MudTd>
                        <MudTd DataLabel="Üniversite">@context.University</MudTd>
                        <MudTd DataLabel="Bölüm">@context.Department</MudTd>
                        <MudTd DataLabel="Sınıf">@context.ClassLevel</MudTd>
                        <MudTd DataLabel="Aylık">@context.MonthlyAmount.ToString("N2") ₺</MudTd>
                        <MudTd DataLabel="Bağışçı">@context.DonorName</MudTd>
                    </RowTemplate>
                </MudTable>
            </MudTabPanel>

            <MudTabPanel Text="Mezun Öğrenciler">
                <MudTable Items="_graduatedStudents" Dense="true" Hover="true" Class="mt-2">
                    <HeaderContent>
                        <MudTh>Öğrenci Adı</MudTh>
                        <MudTh>Üniversite</MudTh>
                        <MudTh>Bölüm</MudTh>
                        <MudTh>Toplam Alınan Burs</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Öğrenci">@context.StudentName</MudTd>
                        <MudTd DataLabel="Üniversite">@context.University</MudTd>
                        <MudTd DataLabel="Bölüm">@context.Department</MudTd>
                        <MudTd DataLabel="Toplam">@context.TotalScholarshipReceived.ToString("N2") ₺</MudTd>
                    </RowTemplate>
                </MudTable>
            </MudTabPanel>

            <MudTabPanel Text="Üniversite Dağılımı">
                <MudTable Items="_universityStats" Dense="true" Hover="true" Class="mt-2">
                    <HeaderContent>
                        <MudTh>Üniversite</MudTh>
                        <MudTh>Öğrenci Sayısı</MudTh>
                        <MudTh>Aylık Toplam</MudTh>
                        <MudTh>Ortalama Burs</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Üniversite">@context.University</MudTd>
                        <MudTd DataLabel="Öğrenci">@context.StudentCount</MudTd>
                        <MudTd DataLabel="Toplam">@context.TotalMonthlyAmount.ToString("N2") ₺</MudTd>
                        <MudTd DataLabel="Ortalama">@((context.TotalMonthlyAmount / context.StudentCount).ToString("N2")) ₺</MudTd>
                    </RowTemplate>
                </MudTable>
            </MudTabPanel>

            <MudTabPanel Text="Yönetim Kurulu">
                <MudTable Items="_executiveBoard" Dense="true" Hover="true" Class="mt-2">
                    <HeaderContent>
                        <MudTh>Üye Adı</MudTh>
                        <MudTh>Rol</MudTh>
                        <MudTh>Durum</MudTh>
                        <MudTh>Burs Veriyor</MudTh>
                        <MudTh>Başlangıç</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Üye">@context.MemberName</MudTd>
                        <MudTd DataLabel="Rol">@context.Role</MudTd>
                        <MudTd DataLabel="Durum">
                            <MudChip T="string" Size="Size.Small" Color="@(context.IsActive ? Color.Success : Color.Default)">
                                @(context.IsActive ? "Aktif" : "Pasif")
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Burs">
                            @if (context.IsProvidingScholarship)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                            }
                        </MudTd>
                        <MudTd DataLabel="Başlangıç">@context.RoleStartDate?.ToString("dd.MM.yyyy")</MudTd>
                    </RowTemplate>
                </MudTable>
            </MudTabPanel>

            <MudTabPanel Text="Dönem Karşılaştırma">
                <MudTable Items="_termComparisons" Dense="true" Hover="true" Class="mt-2">
                    <HeaderContent>
                        <MudTh>Dönem</MudTh>
                        <MudTh>Aktif Öğrenci</MudTh>
                        <MudTh>Mezun</MudTh>
                        <MudTh>Aylık Bütçe</MudTh>
                        <MudTh>Durum</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Dönem">
                            <strong>@context.TermName</strong>
                            @if (context.IsActive)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Primary">Aktif</MudChip>
                            }
                        </MudTd>
                        <MudTd DataLabel="Aktif">@context.ActiveStudents</MudTd>
                        <MudTd DataLabel="Mezun">@context.GraduatedStudents</MudTd>
                        <MudTd DataLabel="Bütçe">@context.MonthlyBudget.ToString("N0") ₺</MudTd>
                        <MudTd DataLabel="Tarih">@context.TermStart.ToString("MM/yyyy") - @context.TermEnd.ToString("MM/yyyy")</MudTd>
                    </RowTemplate>
                </MudTable>
            </MudTabPanel>
        </MudTabs>

        @* Important Note *@
        <MudAlert Severity="Severity.Info" Class="mt-4">
            <strong>ÖNEMLİ:</strong> Bu raporlar seçilen dönem için kayıtlı snapshot verilerini gösterir.
            Örneğin, 2025-2026 döneminde mezun olan öğrenciler, 2026-2027 döneminde görünmez.
            Ancak 2025-2026'ya geri döndüğünüzde, o dönemin tüm verilerini (mezunlar dahil) görebilirsiniz.
        </MudAlert>
    }
</MudContainer>

@code {
    private int? _selectedTermId;
    private List<Term> _terms = new();
    private bool _loading = false;
    private bool _disposed = false;

    // Dashboard data
    private DashboardSummaryDto? _summary;
    private List<StudentTermDetailDto> _activeStudents = new();
    private List<StudentTermDetailDto> _graduatedStudents = new();
    private List<UniversityStatDto> _universityStats = new();
    private List<MemberRoleDto> _executiveBoard = new();
    private List<TermComparisonDto> _termComparisons = new();

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to term change notifications
        TermChangeNotifier.OnTermChanged += OnTermChangedHandler;

        await LoadTermsAsync();

        // Select active term by default
        var activeTerm = await TermService.GetActiveTermAsync();
        if (activeTerm != null)
        {
            _selectedTermId = activeTerm.Id;
            await LoadReportsAsync();
        }
    }

    private async Task LoadTermsAsync()
    {
        _terms = await TermService.GetAllTermsAsync();
    }

    private async void OnTermChangedHandler()
    {
        if (_disposed) return;
        
        try
        {
            // Reload terms when active term changes
            await LoadTermsAsync();
            
            // If currently selected term is no longer active, switch to new active term
            var activeTerm = await TermService.GetActiveTermAsync();
            if (activeTerm != null && _selectedTermId != activeTerm.Id)
            {
                _selectedTermId = activeTerm.Id;
                await LoadReportsAsync();
            }
            
            await InvokeAsync(StateHasChanged);
        }
        catch (ObjectDisposedException)
        {
            // Component already disposed, ignore
        }
    }

    private async Task OnTermSelectedAsync(int termId)
    {
        _selectedTermId = termId;
        await LoadReportsAsync();
    }

    private async Task LoadReportsAsync()
    {
        if (!_selectedTermId.HasValue) return;

        _loading = true;
        StateHasChanged();

        try
        {
            // CRITICAL: All these queries are filtered by TermId
            // This ensures we're getting snapshot data for the selected term
            var termId = _selectedTermId.Value;

            // Load dashboard summary
            _summary = await TermReportService.GetDashboardSummaryAsync(termId);

            // Load active students for this term
            _activeStudents = await TermReportService.GetActiveScholarshipStudentsAsync(termId);

            // Load graduated students for this term
            _graduatedStudents = await TermReportService.GetGraduatedStudentsAsync(termId);

            // Load university statistics for this term
            _universityStats = await TermReportService.GetScholarshipByUniversityAsync(termId);

            // Load executive board members for this term
            _executiveBoard = await TermReportService.GetExecutiveBoardMembersAsync(termId);

            // Load term comparisons (all terms)
            _termComparisons = await TermReportService.GetTermComparisonAsync();
        }
        catch (Exception ex)
        {
            // Handle error (show snackbar, etc.)
            Console.WriteLine($"Error loading reports: {ex.Message}");
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    // IMPORTANT: Watch for changes in _selectedTermId
    protected override async Task OnParametersSetAsync()
    {
        if (_selectedTermId.HasValue)
        {
            await LoadReportsAsync();
        }
    }

    public void Dispose()
    {
        _disposed = true;
        TermChangeNotifier.OnTermChanged -= OnTermChangedHandler;
    }
}
