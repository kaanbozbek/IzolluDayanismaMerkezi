@using IzolluVakfi.Services
@inject MemberScholarshipCommitmentService CommitmentService
@inject SettingsService SettingsService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_success">
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.body1"><strong>Üye:</strong> @MemberName</MudText>
                </MudItem>
                
                <MudItem xs="12" Class="mt-4">
                    <label class="form-label">Dönem *</label>
                    <select id="period-selector-@_instanceId" class="selectpicker" data-width="100%" 
                            data-style="btn-outline-primary" data-live-search="true"
                            value="@_selectedPeriod" @onchange="OnPeriodChanged" title="Dönem Seçiniz">
                        @foreach (var year in _academicYears)
                        {
                            <option value="@year">@year</option>
                        }
                    </select>
                    <small class="form-text text-muted">Taahhüdün geçerli olduğu akademik dönem</small>
                </MudItem>
                
                <MudItem xs="12">
                    <MudNumericField @bind-Value="_commitment.PledgedCount" 
                                    Label="Taahhüt Edilen Burs Adedi" 
                                    Min="0" 
                                    Required="true"
                                    Variant="Variant.Outlined"
                                    HelperText="Bu üyenin vermeyi taahhüt ettiği toplam burs sayısı" />
                </MudItem>

                <MudItem xs="12">
                    <MudNumericField @bind-Value="_commitment.YearlyAmountPerScholarship" 
                                    Label="Burs Başına Yıllık Tutar (₺)" 
                                    Min="0"
                                    Format="N2"
                                    Required="true"
                                    Variant="Variant.Outlined"
                                    ReadOnly="true"
                                    HelperText="Seçili dönem için ayarlardan otomatik yüklenir" />
                </MudItem>

                <MudItem xs="12">
                    <MudNumericField @bind-Value="_commitment.GivenCount" 
                                    Label="Fiilen Verilen Burs Adedi" 
                                    Min="0" 
                                    Max="@_commitment.PledgedCount"
                                    Variant="Variant.Outlined"
                                    HelperText="Bu dönemde gerçekten öğrencilere atanan burs sayısı" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="_commitment.Notes" 
                                 Label="Notlar (Opsiyonel)" 
                                 Lines="3"
                                 Variant="Variant.Outlined"
                                 MaxLength="1000" />
                </MudItem>

                @if (_commitment.PledgedCount > 0 && _commitment.YearlyAmountPerScholarship > 0)
                {
                    <MudItem xs="12" Class="mt-4">
                        <MudPaper Class="pa-4" Elevation="2">
                            <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-3">Özet</MudText>
                            <MudGrid>
                                <MudItem xs="6">
                                    <MudText Typo="Typo.body2"><strong>Fiilen Verilen:</strong></MudText>
                                </MudItem>
                                <MudItem xs="6">
                                    <MudText Typo="Typo.body2" Color="Color.Success">@_commitment.GivenCount adet</MudText>
                                </MudItem>

                                <MudItem xs="6">
                                    <MudText Typo="Typo.body2"><strong>Kalan Burs:</strong></MudText>
                                </MudItem>
                                <MudItem xs="6">
                                    <MudText Typo="Typo.body2">@(_commitment.PledgedCount - _commitment.GivenCount) adet</MudText>
                                </MudItem>

                                <MudItem xs="6">
                                    <MudText Typo="Typo.body2"><strong>Aylık Tutar (Bir Burs):</strong></MudText>
                                </MudItem>
                                <MudItem xs="6">
                                    <MudText Typo="Typo.body2">@((_commitment.YearlyAmountPerScholarship / 12).ToString("N2")) ₺</MudText>
                                </MudItem>

                                <MudItem xs="6">
                                    <MudText Typo="Typo.body2"><strong>Toplam Aylık Tutar:</strong></MudText>
                                </MudItem>
                                <MudItem xs="6">
                                    <MudText Typo="Typo.body2" Color="Color.Success">
                                        <strong>@(((_commitment.YearlyAmountPerScholarship / 12) * _commitment.PledgedCount).ToString("N2")) ₺</strong>
                                    </MudText>
                                </MudItem>

                                <MudItem xs="6">
                                    <MudText Typo="Typo.body2"><strong>Toplam Yıllık Tutar:</strong></MudText>
                                </MudItem>
                                <MudItem xs="6">
                                    <MudText Typo="Typo.body2" Color="Color.Primary">
                                        <strong>@((_commitment.YearlyAmountPerScholarship * _commitment.PledgedCount).ToString("N2")) ₺</strong>
                                    </MudText>
                                </MudItem>
                            </MudGrid>
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">İptal</MudButton>
        <MudButton Color="Color.Error" OnClick="Delete" Disabled="@(!IsEdit)">Sil</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" Disabled="@(!_success)">Kaydet</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    
    [Parameter] public int MemberId { get; set; }
    [Parameter] public string MemberName { get; set; } = string.Empty;
    [Parameter] public bool IsEdit { get; set; }
    [Parameter] public MemberScholarshipCommitment? ExistingCommitment { get; set; }

    private MudForm _form = null!;
    private bool _success;
    private MemberScholarshipCommitment _commitment = new();
    private List<string> _academicYears = new();
    private string _selectedPeriod = "2025-2026";
    private string _instanceId = Guid.NewGuid().ToString("N");
    private bool _isRendered;

    protected override async Task OnInitializedAsync()
    {
        // Load periods from settings first
        var periodsFromSettings = await SettingsService.GetListValueAsync("AcademicPeriods");
        if (periodsFromSettings.Count > 0)
        {
            _academicYears = periodsFromSettings.OrderByDescending(p => p).ToList();
        }
        else
        {
            // Fallback: Generate academic years from 2025-2026 to 2039-2040
            for (int startYear = 2025; startYear <= 2039; startYear++)
            {
                _academicYears.Add($"{startYear}-{startYear + 1}");
            }
        }

        if (IsEdit && ExistingCommitment != null)
        {
            // Edit mode - load existing commitment
            _commitment = new MemberScholarshipCommitment
            {
                Id = ExistingCommitment.Id,
                MemberId = ExistingCommitment.MemberId,
                PledgedCount = ExistingCommitment.PledgedCount,
                GivenCount = ExistingCommitment.GivenCount,
                YearlyAmountPerScholarship = ExistingCommitment.YearlyAmountPerScholarship,
                AcademicYear = ExistingCommitment.AcademicYear,
                Notes = ExistingCommitment.Notes
            };
            _selectedPeriod = ExistingCommitment.AcademicYear ?? _academicYears.FirstOrDefault() ?? "2025-2026";
        }
        else
        {
            // Initialize commitment with default values
            _commitment.MemberId = MemberId;
            _commitment.GivenCount = 0;
            _selectedPeriod = _academicYears.FirstOrDefault() ?? "2025-2026";
            _commitment.AcademicYear = _selectedPeriod;
            
            // Try to load scholarship amount from settings for default period
            await LoadScholarshipAmountForPeriod(_selectedPeriod);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _isRendered = true;
            await InitializeSelectPickerAsync();
        }
    }

    private async Task InitializeSelectPickerAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("bootstrapSelect.init");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Bootstrap select initialization error: {ex.Message}");
        }
    }

    private async Task OnPeriodChanged(ChangeEventArgs e)
    {
        if (e.Value is string newPeriod && !string.IsNullOrWhiteSpace(newPeriod))
        {
            _selectedPeriod = newPeriod;
            _commitment.AcademicYear = newPeriod;
            await LoadScholarshipAmountForPeriod(newPeriod);
            StateHasChanged();
        }
    }

    private async Task LoadScholarshipAmountForPeriod(string period)
    {
        try
        {
            var scholarshipAmounts = await SettingsService.GetScholarshipAmountsAsync();
            var matchingAmount = scholarshipAmounts.FirstOrDefault(a => a.Period == period);
            
            if (matchingAmount != null)
            {
                // Convert monthly amount to yearly (12 months)
                _commitment.YearlyAmountPerScholarship = matchingAmount.Amount * 12;
            }
            else
            {
                // Default value if no setting found
                _commitment.YearlyAmountPerScholarship = 36000;
            }
        }
        catch
        {
            // Fallback to default
            _commitment.YearlyAmountPerScholarship = 36000;
        }
    }

    private async Task Submit()
    {
        await _form.Validate();
        if (!_success)
            return;

        if (_commitment.GivenCount > _commitment.PledgedCount)
        {
            Snackbar.Add("Verilen burs sayısı, taahhüt edilen sayıdan fazla olamaz!", Severity.Warning);
            return;
        }

        try
        {
            if (IsEdit)
            {
                await CommitmentService.UpdateAsync(_commitment);
                Snackbar.Add("Taahhüt başarıyla güncellendi.", Severity.Success);
            }
            else
            {
                await CommitmentService.CreateAsync(_commitment);
                Snackbar.Add("Taahhüt başarıyla oluşturuldu.", Severity.Success);
            }

            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (InvalidOperationException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
    }

    private async Task Delete()
    {
        if (!IsEdit || ExistingCommitment == null)
            return;

        try
        {
            await CommitmentService.DeleteAsync(ExistingCommitment.Id);
            Snackbar.Add("Taahhüt başarıyla silindi.", Severity.Info);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
