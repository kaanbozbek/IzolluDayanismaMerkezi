@inject MemberService MemberService
@inject ActivityLogService ActivityLogService
@inject MemberScholarshipCommitmentService CommitmentService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        @if (IsEdit)
        {
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Centered="false" PanelClass="pa-4">
                <MudTabPanel Text="Genel Bilgiler" Icon="@Icons.Material.Filled.Edit">
                    <MudForm @ref="_form" @bind-IsValid="@_success">
                        <MudGrid>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_member.AdSoyad" Label="Ad Soyad" Required="true" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_member.Meslek" Label="Meslek" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_member.Firma" Label="Firma" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_member.SicilNumarasi" Label="Sicil Numarası" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_member.Email" Label="Email" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_member.Telefon" Label="Telefon" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_member.Adres" Label="Adres" Lines="2" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudCheckBox T="bool" Value="_member.IsIzollulu" Label="İzollulu mu?" Color="Color.Secondary" ValueChanged="OnIsIzolluluChanged" />
                </MudItem>
                <MudItem xs="12" md="6">
                    @if (_member.IsIzollulu)
                    {
                        <label class="form-label">Köy</label>
                        <select class="form-select" @bind="_member.Koy">
                            <option value="">Seçiniz</option>
                            @foreach (var village in _izolluVillages)
                            {
                                <option value="@village">@village</option>
                            }
                        </select>
                    }
                    else
                    {
                        <label class="form-label">İl</label>
                        <select class="form-select" @bind="_member.Koy">
                            <option value="">Seçiniz</option>
                            @foreach (var province in _turkishProvinces)
                            {
                                <option value="@province">@province</option>
                            }
                        </select>
                    }
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_member.Notlar" Label="Notlar" Lines="3" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudCheckBox T="bool" @bind-Value="_member.IsMutevelli" Label="Mütevelli Heyeti" Color="Color.Success" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudCheckBox T="bool" @bind-Value="_member.IsYonetimKurulu" Label="Yönetim Kurulu" Color="Color.Primary" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudCheckBox T="bool" @bind-Value="_member.BursVeriyor" Label="Burs Veriyor" Color="Color.Warning" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudCheckBox T="bool" @bind-Value="_member.AktifMi" Label="Aktif" Color="Color.Info" />
                </MudItem>
            </MudGrid>
        </MudForm>
                </MudTabPanel>

                <MudTabPanel Text="Taahhüt Geçmişi" Icon="@Icons.Material.Filled.Payment">
                    <div class="mt-4">
                        @if (!_member.BursVeriyor)
                        {
                            <MudAlert Severity="Severity.Info">Bu üye bağışçı olarak işaretlenmemiş. Taahhüt geçmişi yalnızca bağışçılar için görüntülenir.</MudAlert>
                        }
                        else if (_pledgeHistory.Count == 0)
                        {
                            <MudAlert Severity="Severity.Info">Bu bağışçı için henüz taahhüt kaydı bulunmuyor.</MudAlert>
                        }
                        else
                        {
                            <MudTable Items="@_member.ScholarshipCommitments" Dense="true" Hover="true" Elevation="2">
                                <HeaderContent>
                                    <MudTh Style="text-align: right;">Taahhüt Edilen</MudTh>
                                    <MudTh Style="text-align: right;">Ödenen</MudTh>
                                    <MudTh Style="text-align: right;">Kalan</MudTh>
                                    <MudTh Style="text-align: right;">Yıllık Tutar/Burs</MudTh>
                                    <MudTh Style="text-align: right;">Toplam Taahhüt Tutarı</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Taahhüt Edilen" Style="text-align: right;">
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">@context.PledgedCount</MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Ödenen" Style="text-align: right;">
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success">@context.GivenCount</MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Kalan" Style="text-align: right;">
                                        <MudChip T="string" Size="Size.Small" Color="@(context.RemainingCount > 0 ? Color.Warning : Color.Default)">
                                            @context.RemainingCount
                                        </MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Yıllık Tutar/Burs" Style="text-align: right;">
                                        @context.YearlyAmountPerScholarship.ToString("N0") ₺
                                    </MudTd>
                                    <MudTd DataLabel="Toplam Taahhüt Tutarı" Style="text-align: right;">
                                        <strong>@context.TotalYearlyAmount.ToString("N0") ₺</strong>
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>

                            <MudPaper Elevation="0" Class="mt-4 pa-3" Style="background-color: #f5f5f5;">
                                <MudGrid>
                                    <MudItem xs="12" md="3">
                                        <MudText Typo="Typo.subtitle2" Color="Color.Primary">Toplam Taahhüt Edilen:</MudText>
                                        <MudText Typo="Typo.h6"><strong>@_pledgeHistory.Sum(p => p.PledgedCount)</strong></MudText>
                                    </MudItem>
                                    <MudItem xs="12" md="3">
                                        <MudText Typo="Typo.subtitle2" Color="Color.Success">Toplam Ödenen:</MudText>
                                        <MudText Typo="Typo.h6"><strong>@_pledgeHistory.Sum(p => p.GivenCount)</strong></MudText>
                                    </MudItem>
                                    <MudItem xs="12" md="3">
                                        <MudText Typo="Typo.subtitle2" Color="Color.Warning">Toplam Kalan:</MudText>
                                        <MudText Typo="Typo.h6"><strong>@_pledgeHistory.Sum(p => p.RemainingCount)</strong></MudText>
                                    </MudItem>
                                    <MudItem xs="12" md="3">
                                        <MudText Typo="Typo.subtitle2" Color="Color.Default">Toplam Taahhüt Tutarı:</MudText>
                                        <MudText Typo="Typo.h6"><strong>@_pledgeHistory.Sum(p => p.TotalYearlyAmount).ToString("N0") ₺</strong></MudText>
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        }
                    </div>
                </MudTabPanel>

                <MudTabPanel Text="Hareket Logları" Icon="@Icons.Material.Filled.History">
                    <div class="mt-4">
                        @if (_activityLogs.Count == 0)
                        {
                            <MudAlert Severity="Severity.Info">Bu üye için hareket logu bulunamadı.</MudAlert>
                        }
                        else
                        {
                            <MudTable Items="@_activityLogs" Dense="true" Hover="true">
                                <HeaderContent>
                                    <MudTh>Tarih</MudTh>
                                    <MudTh>İşlem Tipi</MudTh>
                                    <MudTh>Detay</MudTh>
                                    <MudTh>Kullanıcı</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Tarih">@context.Tarih.ToString("dd.MM.yyyy HH:mm")</MudTd>
                                    <MudTd DataLabel="İşlem Tipi">
                                        <MudChip T="string" Size="Size.Small" Color="@GetLogTypeColor(context.IslemTipi)">
                                            @GetLogTypeText(context.IslemTipi)
                                        </MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Detay">@context.Detay</MudTd>
                                    <MudTd DataLabel="Kullanıcı">@context.KullaniciAdi</MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                    </div>
                </MudTabPanel>
            </MudTabs>
        }
        else
        {
            <MudForm @ref="_form" @bind-IsValid="@_success">
                <MudGrid>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_member.AdSoyad" Label="Ad Soyad" Required="true" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_member.Meslek" Label="Meslek" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_member.Firma" Label="Firma" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_member.SicilNumarasi" Label="Sicil Numarası" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_member.Email" Label="Email" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_member.Email" Label="Email" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_member.Telefon" Label="Telefon" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_member.Adres" Label="Adres" Lines="2" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudCheckBox T="bool" Value="_member.IsIzollulu" Label="İzollulu mu?" Color="Color.Secondary" ValueChanged="OnIsIzolluluChanged" />
                </MudItem>
                <MudItem xs="12" md="6">
                    @if (_member.IsIzollulu)
                    {
                        <label class="form-label">Köy</label>
                        <select class="form-select" @bind="_member.Koy">
                            <option value="">Seçiniz</option>
                            @foreach (var village in _izolluVillages)
                            {
                                <option value="@village">@village</option>
                            }
                        </select>
                    }
                    else
                    {
                        <label class="form-label">İl</label>
                        <select class="form-select" @bind="_member.Koy">
                            <option value="">Seçiniz</option>
                            @foreach (var province in _turkishProvinces)
                            {
                                <option value="@province">@province</option>
                            }
                        </select>
                    }
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_member.Notlar" Label="Notlar" Lines="3" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudCheckBox T="bool" @bind-Value="_member.IsMutevelli" Label="Mütevelli Heyeti" Color="Color.Success" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudCheckBox T="bool" @bind-Value="_member.IsYonetimKurulu" Label="Yönetim Kurulu" Color="Color.Primary" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudCheckBox T="bool" @bind-Value="_member.BursVeriyor" Label="Burs Veriyor" Color="Color.Warning" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudCheckBox T="bool" @bind-Value="_member.AktifMi" Label="Aktif" Color="Color.Info" />
                </MudItem>
            </MudGrid>
        </MudForm>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">İptal</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" Disabled="@(!_success)">Kaydet</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public bool IsEdit { get; set; }
    [Parameter] public Member? Member { get; set; }

    private MudForm _form = null!;
    private bool _success;
    private Member _member = new();
    private List<ActivityLog> _activityLogs = new();
    private List<MemberScholarshipCommitment> _pledgeHistory = new();

    protected override async Task OnInitializedAsync()
    {
        if (IsEdit && Member != null)
        {
            _member = Member;
            _activityLogs = await ActivityLogService.GetByPersonNameAsync(_member.AdSoyad);
            
            // Load pledge history if member is a donor
            if (_member.BursVeriyor)
            {
                _pledgeHistory = await CommitmentService.GetByMemberAsync(_member.Id);
            }
        }
        else
        {
            _member.AktifMi = true;
        }
    }

    private async Task Submit()
    {
        await _form.Validate();
        if (_success)
        {
            try
            {
                if (IsEdit)
                {
                    await MemberService.UpdateAsync(_member);
                }
                else
                {
                    await MemberService.CreateAsync(_member);
                }

                MudDialog.Close(DialogResult.Ok(true));
            }
            catch (InvalidOperationException ex)
            {
                Snackbar.Add(ex.Message, Severity.Error);
            }
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private Color GetLogTypeColor(string islemTipi)
    {
        return islemTipi switch
        {
            "UyeEkle" => Color.Success,
            "UyeGuncelle" => Color.Info,
            "UyeSil" => Color.Error,
            _ => Color.Default
        };
    }

    private string GetLogTypeText(string islemTipi)
    {
        return islemTipi switch
        {
            "UyeEkle" => "Ekleme",
            "UyeGuncelle" => "Güncelleme",
            "UyeSil" => "Silme",
            _ => islemTipi
        };
    }

    private readonly List<string> _izolluVillages = new()
    {
        "Abuşoğlu", "Akça", "Akuşağı", "Bağlıca", "Bentköy", "Çanakçı", "Darıpınar", "Dedeköy",
        "Düztarla", "Erdemli", "Gülenköy", "Güneyce", "İkizpınar", "Kaleköy", "Karaağaç",
        "Karahüseyin", "Kıyıcak", "Kozluk", "Kumluyazı", "Mahmut Dursun", "Salkımlı", "Sarıot",
        "Soğukpınar", "Tepebaşı", "Uyanık", "Uzunhüseyin", "Üçdeğirmen", "Yenidamlar"
    };

    private readonly List<string> _turkishProvinces = new()
    {
        "Adana", "Adıyaman", "Afyonkarahisar", "Ağrı", "Aksaray", "Amasya", "Ankara", "Antalya",
        "Ardahan", "Artvin", "Aydın", "Balıkesir", "Bartın", "Batman", "Bayburt", "Bilecik",
        "Bingöl", "Bitlis", "Bolu", "Burdur", "Bursa", "Çanakkale", "Çankırı", "Çorum",
        "Denizli", "Diyarbakır", "Düzce", "Edirne", "Elazığ", "Erzincan", "Erzurum", "Eskişehir",
        "Gaziantep", "Giresun", "Gümüşhane", "Hakkari", "Hatay", "Iğdır", "Isparta", "İstanbul",
        "İzmir", "Kahramanmaraş", "Karabük", "Karaman", "Kars", "Kastamonu", "Kayseri", "Kilis",
        "Kırıkkale", "Kırklareli", "Kırşehir", "Kocaeli", "Konya", "Kütahya", "Malatya", "Manisa",
        "Mardin", "Mersin", "Muğla", "Muş", "Nevşehir", "Niğde", "Ordu", "Osmaniye",
        "Rize", "Sakarya", "Samsun", "Şanlıurfa", "Siirt", "Sinop", "Şırnak", "Sivas",
        "Tekirdağ", "Tokat", "Trabzon", "Tunceli", "Uşak", "Van", "Yalova", "Yozgat", "Zonguldak"
    };

    private void OnIsIzolluluChanged(bool value)
    {
        _member.IsIzollulu = value;
        _member.Koy = null;
        StateHasChanged();
    }
}