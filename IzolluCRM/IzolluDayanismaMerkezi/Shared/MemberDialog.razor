@inject MemberService MemberService
@inject ActivityLogService ActivityLogService
@inject MemberScholarshipCommitmentService CommitmentService
@inject SettingsService SettingsService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<MudDialog Style="max-width: 800px; min-height: 600px;">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" Style="vertical-align: middle;" />
            @(IsEdit ? "Üye Düzenle" : "Yeni Üye Ekle")
        </MudText>
    </TitleContent>
    <DialogContent>
        <div style="max-height: 70vh; overflow-y: auto;">
        @if (IsEdit)
        {
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Centered="false" PanelClass="pa-4">
                <MudTabPanel Text="Genel Bilgiler" Icon="@Icons.Material.Filled.Edit">
                    @RenderMemberForm()
                </MudTabPanel>

                <MudTabPanel Text="Taahhüt Geçmişi" Icon="@Icons.Material.Filled.Payment">
                    <div class="mt-4">
                        @if (!_member.BursVeriyor)
                        {
                            <MudAlert Severity="Severity.Info">Bu üye bağışçı olarak işaretlenmemiş. Taahhüt geçmişi yalnızca bağışçılar için görüntülenir.</MudAlert>
                        }
                        else if (_pledgeHistory.Count == 0)
                        {
                            <MudAlert Severity="Severity.Info">Bu bağışçı için henüz taahhüt kaydı bulunmuyor.</MudAlert>
                        }
                        else
                        {
                            <MudTable Items="@_member.ScholarshipCommitments" Dense="true" Hover="true" Elevation="2">
                                <HeaderContent>
                                    <MudTh Style="text-align: right;">Taahhüt Edilen</MudTh>
                                    <MudTh Style="text-align: right;">Ödenen</MudTh>
                                    <MudTh Style="text-align: right;">Kalan</MudTh>
                                    <MudTh Style="text-align: right;">Yıllık Tutar/Burs</MudTh>
                                    <MudTh Style="text-align: right;">Toplam Taahhüt Tutarı</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Taahhüt Edilen" Style="text-align: right;">
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">@context.PledgedCount</MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Ödenen" Style="text-align: right;">
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success">@context.GivenCount</MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Kalan" Style="text-align: right;">
                                        <MudChip T="string" Size="Size.Small" Color="@(context.RemainingCount > 0 ? Color.Warning : Color.Default)">
                                            @context.RemainingCount
                                        </MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Yıllık Tutar/Burs" Style="text-align: right;">
                                        @context.YearlyAmountPerScholarship.ToString("N0") ₺
                                    </MudTd>
                                    <MudTd DataLabel="Toplam Taahhüt Tutarı" Style="text-align: right;">
                                        <strong>@context.TotalYearlyAmount.ToString("N0") ₺</strong>
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>

                            <MudPaper Elevation="0" Class="mt-4 pa-3" Style="background-color: #f5f5f5;">
                                <MudGrid Spacing="2">
                                    <MudItem xs="6" md="3">
                                        <MudText Typo="Typo.subtitle2" Color="Color.Primary" Style="font-size: 0.75rem;">Toplam Taahhüt Edilen:</MudText>
                                        <MudText Typo="Typo.h6"><strong>@_pledgeHistory.Sum(p => p.PledgedCount)</strong></MudText>
                                    </MudItem>
                                    <MudItem xs="6" md="3">
                                        <MudText Typo="Typo.subtitle2" Color="Color.Success" Style="font-size: 0.75rem;">Toplam Ödenen:</MudText>
                                        <MudText Typo="Typo.h6"><strong>@_pledgeHistory.Sum(p => p.GivenCount)</strong></MudText>
                                    </MudItem>
                                    <MudItem xs="6" md="3">
                                        <MudText Typo="Typo.subtitle2" Color="Color.Warning" Style="font-size: 0.75rem;">Toplam Kalan:</MudText>
                                        <MudText Typo="Typo.h6"><strong>@_pledgeHistory.Sum(p => p.RemainingCount)</strong></MudText>
                                    </MudItem>
                                    <MudItem xs="6" md="3">
                                        <MudText Typo="Typo.subtitle2" Color="Color.Default" Style="font-size: 0.75rem;">Toplam Taahhüt Tutarı:</MudText>
                                        <MudText Typo="Typo.h6"><strong>@_pledgeHistory.Sum(p => p.TotalYearlyAmount).ToString("N0") ₺</strong></MudText>
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        }
                    </div>
                </MudTabPanel>

                <MudTabPanel Text="Hareket Logları" Icon="@Icons.Material.Filled.History">
                    <div class="mt-4">
                        @if (_activityLogs.Count == 0)
                        {
                            <MudAlert Severity="Severity.Info">Bu üye için hareket logu bulunamadı.</MudAlert>
                        }
                        else
                        {
                            <MudTable Items="@_activityLogs" Dense="true" Hover="true">
                                <HeaderContent>
                                    <MudTh>Tarih</MudTh>
                                    <MudTh>İşlem Tipi</MudTh>
                                    <MudTh>Detay</MudTh>
                                    <MudTh>Kullanıcı</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Tarih">@context.Tarih.ToString("dd.MM.yyyy HH:mm")</MudTd>
                                    <MudTd DataLabel="İşlem Tipi">
                                        <MudChip T="string" Size="Size.Small" Color="@GetLogTypeColor(context.IslemTipi)">
                                            @GetLogTypeText(context.IslemTipi)
                                        </MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Detay">@context.Detay</MudTd>
                                    <MudTd DataLabel="Kullanıcı">@context.KullaniciAdi</MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                    </div>
                </MudTabPanel>
            </MudTabs>
        }
        else
        {
            @RenderMemberForm()
        }
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">İptal</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" Disabled="@(!_success)" Variant="Variant.Filled">
            @(IsEdit ? "Güncelle" : "Kaydet")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public bool IsEdit { get; set; }
    [Parameter] public Member? Member { get; set; }

    private MudForm _form = null!;
    private bool _success;
    private Member _member = new();
    private List<ActivityLog> _activityLogs = new();
    private List<MemberScholarshipCommitment> _pledgeHistory = new();
    private List<string> _sectors = new();
    private List<string> _periods = new();
    private bool _isLoadingSectors = true;
    private bool _isLoadingPeriods = true;

    private RenderFragment RenderMemberForm() => __builder =>
    {
        <MudForm @ref="_form" @bind-IsValid="@_success">
            @* Kişisel Bilgiler *@
            <MudPaper Elevation="0" Class="pa-3 mb-3" Style="background-color: #ede9fe; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-1" />
                    Kişisel Bilgiler
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_member.AdSoyad" Label="Ad Soyad" Required="true" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_member.SicilNumarasi" Label="Sicil Numarası" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudCheckBox T="bool" Value="_member.IsIzollulu" ValueChanged="OnIsIzolluluChanged" Label="İzollulu mu?" Color="Color.Secondary" />
                    </MudItem>
                    <MudItem xs="12" md="8">
                        @if (_member.IsIzollulu)
                        {
                            <div class="form-group">
                                <label class="form-label">Köy</label>
                                <select class="selectpicker form-control" data-live-search="true" data-width="100%"
                                        @onchange="@(e => _member.Koy = e.Value?.ToString())">
                                    <option value="">Seçiniz</option>
                                    @foreach (var village in _izolluVillages)
                                    {
                                        <option value="@village" selected="@(_member.Koy == village)">@village</option>
                                    }
                                </select>
                            </div>
                        }
                        else
                        {
                            <div class="form-group">
                                <label class="form-label">İl</label>
                                <select class="selectpicker form-control" data-live-search="true" data-width="100%"
                                        @onchange="@(e => _member.Koy = e.Value?.ToString())">
                                    <option value="">Seçiniz</option>
                                    @foreach (var province in _turkishProvinces)
                                    {
                                        <option value="@province" selected="@(_member.Koy == province)">@province</option>
                                    }
                                </select>
                            </div>
                        }
                    </MudItem>
                </MudGrid>
            </MudPaper>

            @* Meslek Bilgileri *@
            <MudPaper Elevation="0" Class="pa-3 mb-3" Style="background-color: #fed7aa; border-radius: 8px; border-left: 4px solid #f59e0b;">
                <MudText Typo="Typo.subtitle2" Style="color: #b45309;" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Work" Size="Size.Small" Class="mr-1" />
                    Meslek Bilgileri
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_member.Meslek" Label="Meslek" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_member.Firma" Label="Firma" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        @if (_isLoadingSectors)
                        {
                            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="40px" />
                        }
                        else
                        {
                            <div class="form-group">
                                <label class="form-label">Sektör</label>
                                <select class="form-select selectpicker" data-live-search="true" @bind="_member.Sektor">
                                    <option value="">Seçiniz</option>
                                    @foreach (var sector in _sectors)
                                    {
                                        <option value="@sector">@sector</option>
                                    }
                                </select>
                            </div>
                        }
                    </MudItem>
                </MudGrid>
            </MudPaper>

            @* İletişim Bilgileri *@
            <MudPaper Elevation="0" Class="pa-3 mb-3" Style="background-color: #d1fae5; border-radius: 8px; border-left: 4px solid #10b981;">
                <MudText Typo="Typo.subtitle2" Color="Color.Success" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.ContactPhone" Size="Size.Small" Class="mr-1" />
                    İletişim Bilgileri
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_member.Email" Label="Email" InputType="InputType.Email" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_member.Telefon" Label="Telefon" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_member.Adres" Label="Adres" Lines="2" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                </MudGrid>
            </MudPaper>

            @* Üyelik Durumu *@
            <MudPaper Elevation="0" Class="pa-3 mb-3" Style="background-color: #dbeafe; border-radius: 8px; border-left: 4px solid #3b82f6;">
                <MudText Typo="Typo.subtitle2" Color="Color.Info" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Badge" Size="Size.Small" Class="mr-1" />
                    Üyelik Durumu
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="6" md="3">
                        <MudCheckBox T="bool" @bind-Value="_member.IsMutevelli" Label="Kurucular Heyeti" Color="Color.Success" />
                    </MudItem>
                    <MudItem xs="6" md="3">
                        <MudCheckBox T="bool" @bind-Value="_member.IsYonetimKurulu" Label="Yönetim Kurulu" Color="Color.Primary" />
                    </MudItem>
                    <MudItem xs="6" md="3">
                        <MudCheckBox T="bool" @bind-Value="_member.BursVeriyor" Label="Burs Veriyor" Color="Color.Warning" />
                    </MudItem>
                    <MudItem xs="6" md="3">
                        <MudCheckBox T="bool" @bind-Value="_member.AktifMi" Label="Aktif" Color="Color.Info" />
                    </MudItem>
                </MudGrid>
            </MudPaper>

            @* Görev Bilgileri (Sadece Edit modunda) *@
            @if (IsEdit)
            {
                <MudPaper Elevation="0" Class="pa-3 mb-3" Style="background-color: #fdf4ff; border-radius: 8px; border-left: 4px solid #a855f7;">
                    <MudText Typo="Typo.subtitle2" Style="color: #9333ea;" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" Class="mr-1" />
                        Görev Bilgileri
                    </MudText>
                    <MudGrid Spacing="2">
                        <MudItem xs="12" md="4">
                            @if (_isLoadingPeriods)
                            {
                                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="40px" />
                            }
                            else
                            {
                                <div class="form-group">
                                    <label class="form-label">Görev Dönemi</label>
                                    <select class="form-select selectpicker" data-live-search="true" @bind="_member.MembershipPeriod">
                                        <option value="">Seçiniz</option>
                                        @foreach (var period in _periods)
                                        {
                                            <option value="@period">@period</option>
                                        }
                                    </select>
                                </div>
                            }
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <div class="form-group">
                                <label class="form-label">Görev Başlangıç</label>
                                <input type="date" class="form-control" 
                                       value="@(_member.RoleStartDate?.ToString("yyyy-MM-dd"))"
                                       @onchange="@(e => _member.RoleStartDate = DateTime.TryParse(e.Value?.ToString(), out var dt) ? dt : null)" />
                            </div>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <div class="form-group">
                                <label class="form-label">Görev Bitiş</label>
                                <input type="date" class="form-control" 
                                       value="@(_member.RoleEndDate?.ToString("yyyy-MM-dd"))"
                                       @onchange="@(e => _member.RoleEndDate = DateTime.TryParse(e.Value?.ToString(), out var dt) ? dt : null)" />
                            </div>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            }

            @* Notlar *@
            <MudPaper Elevation="0" Class="pa-3 mb-3" Style="background-color: #fed7aa; border-radius: 8px; border-left: 4px solid #f59e0b;">
                <MudText Typo="Typo.subtitle2" Style="color: #b45309;" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Notes" Size="Size.Small" Class="mr-1" />
                    Notlar
                </MudText>
                <MudTextField @bind-Value="_member.Notlar" 
                              Label="Notlar" 
                              Lines="3" 
                              Variant="Variant.Outlined"
                              Placeholder="Üye ile ilgili notlarınızı buraya yazabilirsiniz..." />
            </MudPaper>
        </MudForm>
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeSelectPickersAsync();
        }
    }

    private async Task InitializeSelectPickersAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("bootstrapSelect.init");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Bootstrap select initialization error: {ex.Message}");
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _isLoadingSectors = true;
        _isLoadingPeriods = true;
        
        var sectorsTask = SettingsService.GetListValueAsync("Sektorler");
        var periodsTask = SettingsService.GetListValueAsync("Donemler");
        
        await Task.WhenAll(sectorsTask, periodsTask);
        
        _sectors = await sectorsTask;
        _periods = await periodsTask;
        
        _isLoadingSectors = false;
        _isLoadingPeriods = false;
        
        if (IsEdit && Member != null)
        {
            _member = Member;
            _activityLogs = await ActivityLogService.GetByPersonNameAsync(_member.AdSoyad);
            _success = true;
            
            if (_member.BursVeriyor)
            {
                _pledgeHistory = await CommitmentService.GetByMemberAsync(_member.Id);
            }
        }
        else
        {
            _member.AktifMi = true;
            _member.SicilNumarasi = await MemberService.GetNextSicilNumarasiAsync();
        }
    }

    private async Task Submit()
    {
        await _form.Validate();
        if (_success)
        {
            try
            {
                if (IsEdit)
                {
                    await MemberService.UpdateAsync(_member);
                    Snackbar.Add("Üye başarıyla güncellendi.", Severity.Success);
                }
                else
                {
                    await MemberService.CreateAsync(_member);
                    Snackbar.Add("Üye başarıyla eklendi.", Severity.Success);
                }

                MudDialog.Close(DialogResult.Ok(true));
            }
            catch (InvalidOperationException ex)
            {
                Snackbar.Add(ex.Message, Severity.Error);
            }
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private Color GetLogTypeColor(string islemTipi) => islemTipi switch
    {
        "UyeEkle" => Color.Success,
        "UyeGuncelle" => Color.Info,
        "UyeSil" => Color.Error,
        _ => Color.Default
    };

    private string GetLogTypeText(string islemTipi) => islemTipi switch
    {
        "UyeEkle" => "Ekleme",
        "UyeGuncelle" => "Güncelleme",
        "UyeSil" => "Silme",
        _ => islemTipi
    };

    private readonly List<string> _izolluVillages = new()
    {
        "Abuşoğlu", "Akça", "Akuşağı", "Bağlıca", "Bentköy", "Çanakçı", "Darıpınar", "Dedeköy",
        "Düztarla", "Erdemli", "Gülenköy", "Güneyce", "İkizpınar", "Kaleköy", "Karaağaç",
        "Karahüseyin", "Kıyıcak", "Kozluk", "Kumluyazı", "Mahmut Dursun", "Salkımlı", "Sarıot",
        "Soğukpınar", "Tepebaşı", "Uyanık", "Uzunhüseyin", "Üçdeğirmen", "Yenidamlar"
    };

    private readonly List<string> _turkishProvinces = new()
    {
        "Adana", "Adıyaman", "Afyonkarahisar", "Ağrı", "Aksaray", "Amasya", "Ankara", "Antalya",
        "Ardahan", "Artvin", "Aydın", "Balıkesir", "Bartın", "Batman", "Bayburt", "Bilecik",
        "Bingöl", "Bitlis", "Bolu", "Burdur", "Bursa", "Çanakkale", "Çankırı", "Çorum",
        "Denizli", "Diyarbakır", "Düzce", "Edirne", "Elazığ", "Erzincan", "Erzurum", "Eskişehir",
        "Gaziantep", "Giresun", "Gümüşhane", "Hakkari", "Hatay", "Iğdır", "Isparta", "İstanbul",
        "İzmir", "Kahramanmaraş", "Karabük", "Karaman", "Kars", "Kastamonu", "Kayseri", "Kilis",
        "Kırıkkale", "Kırklareli", "Kırşehir", "Kocaeli", "Konya", "Kütahya", "Malatya", "Manisa",
        "Mardin", "Mersin", "Muğla", "Muş", "Nevşehir", "Niğde", "Ordu", "Osmaniye",
        "Rize", "Sakarya", "Samsun", "Şanlıurfa", "Siirt", "Sinop", "Şırnak", "Sivas",
        "Tekirdağ", "Tokat", "Trabzon", "Tunceli", "Uşak", "Van", "Yalova", "Yozgat", "Zonguldak"
    };

    private async Task OnIsIzolluluChanged(bool value)
    {
        _member.IsIzollulu = value;
        _member.Koy = null;
        StateHasChanged();
        await Task.Delay(50);
        await InitializeSelectPickersAsync();
    }
}