@using IzolluVakfi.Data.Entities
@using IzolluVakfi.Services
@inject TranscriptService TranscriptService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <div class="form-group">
                <label class="form-label">GNO *</label>
                <select id="gnoSelect" class="form-control">
                    <option value="">GNO Seçiniz</option>
                    @for (decimal i = 0.0m; i <= 4.0m; i += 0.1m)
                    {
                        <option value="@i.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)">@i.ToString("F1")</option>
                    }
                </select>
                <small class="form-text text-muted">0.0 - 4.0 arası bir değer seçin</small>
            </div>

            <label class="form-label">Giriş Tarihi</label>
            <InputDate @bind-Value="_girisTarihi" class="form-control" />

            <MudTextField @bind-Value="_transcript.Notlar" 
                         Label="Notlar" 
                         Variant="Variant.Outlined" 
                         Lines="3" />

            <MudFileUpload T="IBrowserFile" 
                          Accept=".pdf" 
                          OnFilesChanged="OnFileSelected"
                          MaximumFileCount="1">
                <ActivatorContent>
                    <MudButton Variant="Variant.Filled"
                              Color="Color.Primary"
                              StartIcon="@Icons.Material.Filled.CloudUpload">
                        PDF Yükle
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>

            @if (!string.IsNullOrEmpty(_fileName))
            {
                <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.AttachFile">
                    @_fileName
                </MudChip>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">İptal</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Save">Kaydet</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public int StudentId { get; set; }

    private TranscriptRecord _transcript = new();
    private DateTime? _girisTarihi = DateTime.Now;
    private IBrowserFile? _selectedFile;
    private string _fileName = string.Empty;
    private decimal _selectedGno = 0m;

    protected override void OnInitialized()
    {
        _transcript.StudentId = StudentId;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await JS.InvokeVoidAsync("select2Helper.initializeGnoSelect", "gnoSelect");
            }
            catch (Exception)
            {
                // Fallback to regular dropdown if Select2 fails
            }
        }
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
        _fileName = e.File.Name;
    }

    private async Task Save()
    {
        // Get selected GNO value
        string? gnoValue = null;
        try
        {
            gnoValue = await JS.InvokeAsync<string>("select2Helper.getValue", "gnoSelect");
        }
        catch
        {
            Snackbar.Add("GNO değeri alınırken hata oluştu", Severity.Error);
            return;
        }
        
        if (string.IsNullOrWhiteSpace(gnoValue))
        {
            Snackbar.Add("Lütfen bir GNO değeri seçiniz", Severity.Warning);
            return;
        }

        if (!decimal.TryParse(gnoValue, System.Globalization.NumberStyles.AllowDecimalPoint, System.Globalization.CultureInfo.InvariantCulture, out decimal gno))
        {
            Snackbar.Add("Geçersiz GNO değeri", Severity.Warning);
            return;
        }

        _transcript.GNO = gno;

        if (!_girisTarihi.HasValue)
        {
            Snackbar.Add("Lütfen giriş tarihi seçiniz", Severity.Warning);
            return;
        }

        _transcript.GirisTarihi = _girisTarihi.Value;

        // PDF dosyasını kaydet
        if (_selectedFile != null)
        {
            try
            {
                var uploadsPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", "transcripts");
                Directory.CreateDirectory(uploadsPath);

                var fileName = $"{StudentId}_{DateTime.Now:yyyyMMddHHmmss}_{_selectedFile.Name}";
                var filePath = Path.Combine(uploadsPath, fileName);

                await using FileStream fs = new(filePath, FileMode.Create);
                await _selectedFile.OpenReadStream(maxAllowedSize: 10485760).CopyToAsync(fs); // 10MB limit

                _transcript.PdfDosyaYolu = $"/uploads/transcripts/{fileName}";
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Dosya yüklenirken hata oluştu: {ex.Message}", Severity.Error);
                return;
            }
        }

        await TranscriptService.CreateAsync(_transcript);
        Snackbar.Add("Transkript başarıyla eklendi", Severity.Success);
        MudDialog.Close(DialogResult.Ok(true));
    }

    private void Cancel() => MudDialog.Cancel();
}
