@using IzolluVakfi.Data.Entities
@using IzolluVakfi.Services
@inject TranscriptService TranscriptService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <MudTextField @bind-Value="_gnoString" 
                         Label="GNO" 
                         Variant="Variant.Outlined" 
                         Required="true"
                         Immediate="true"
                         HelperText="Örnek: 2.50" />

            <label class="form-label">Giriş Tarihi</label>
            <InputDate @bind-Value="_girisTarihi" class="form-control" />

            <MudTextField @bind-Value="_transcript.Notlar" 
                         Label="Notlar" 
                         Variant="Variant.Outlined" 
                         Lines="3" />

            <MudFileUpload T="IBrowserFile" 
                          Accept=".pdf" 
                          OnFilesChanged="OnFileSelected"
                          MaximumFileCount="1">
                <ActivatorContent>
                    <MudButton Variant="Variant.Filled"
                              Color="Color.Primary"
                              StartIcon="@Icons.Material.Filled.CloudUpload">
                        PDF Yükle
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>

            @if (!string.IsNullOrEmpty(_fileName))
            {
                <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.AttachFile">
                    @_fileName
                </MudChip>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">İptal</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Save">Kaydet</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public int StudentId { get; set; }

    private TranscriptRecord _transcript = new();
    private DateTime? _girisTarihi = DateTime.Now;
    private IBrowserFile? _selectedFile;
    private string _fileName = string.Empty;
    private string _gnoString = string.Empty;

    protected override void OnInitialized()
    {
        _transcript.StudentId = StudentId;
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
        _fileName = e.File.Name;
    }

    private async Task Save()
    {
        // Parse GNO from string
        if (!decimal.TryParse(_gnoString.Replace(',', '.'), System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out decimal gno) || gno <= 0 || gno > 4)
        {
            Snackbar.Add("Lütfen geçerli bir GNO giriniz (0-4 arası)", Severity.Warning);
            return;
        }

        _transcript.GNO = gno;

        if (!_girisTarihi.HasValue)
        {
            Snackbar.Add("Lütfen giriş tarihi seçiniz", Severity.Warning);
            return;
        }

        _transcript.GirisTarihi = _girisTarihi.Value;

        // PDF dosyasını kaydet
        if (_selectedFile != null)
        {
            try
            {
                var uploadsPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", "transcripts");
                Directory.CreateDirectory(uploadsPath);

                var fileName = $"{StudentId}_{DateTime.Now:yyyyMMddHHmmss}_{_selectedFile.Name}";
                var filePath = Path.Combine(uploadsPath, fileName);

                await using FileStream fs = new(filePath, FileMode.Create);
                await _selectedFile.OpenReadStream(maxAllowedSize: 10485760).CopyToAsync(fs); // 10MB limit

                _transcript.PdfDosyaYolu = $"/uploads/transcripts/{fileName}";
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Dosya yüklenirken hata oluştu: {ex.Message}", Severity.Error);
                return;
            }
        }

        await TranscriptService.CreateAsync(_transcript);
        Snackbar.Add("Transkript başarıyla eklendi", Severity.Success);
        MudDialog.Close(DialogResult.Ok(true));
    }

    private void Cancel() => MudDialog.Cancel();
}
