@inject StudentService StudentService
@inject TranscriptService TranscriptService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject MeetingService MeetingService
@inject ActivityLogService ActivityLogService
@implements IDisposable

<MudDialog>
    <DialogContent>
        @if (_loading)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (_student != null)
        {
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Centered="false" PanelClass="pa-4" @bind-ActivePanelIndex="_activePanelIndex">
                <MudTabPanel Text="Genel Bilgiler" Icon="@Icons.Material.Filled.Person">
                    <MudGrid Class="mt-4">
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2" Color="Color.Default"><strong>Ad Soyad:</strong> @_student.AdSoyad</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2"><strong>TC No:</strong> @_student.TCNo</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2"><strong>Email:</strong> @_student.Email</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2"><strong>Telefon:</strong> @_student.Telefon</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2"><strong>Doğum Tarihi:</strong> @_student.DogumTarihi?.ToString("dd.MM.yyyy")</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2"><strong>Yaş:</strong> @_student.Yas</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2"><strong>Cinsiyet:</strong> @_student.Cinsiyet</MudText>
                        </MudItem>
                        <MudItem xs="12">
                            <MudText Typo="Typo.body2"><strong>Adres:</strong> @_student.Adres</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2"><strong>Üniversite:</strong> @_student.Universite</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2"><strong>Bölüm:</strong> @_student.Bolum</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2"><strong>Sınıf:</strong> @_student.Sinif</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2"><strong>IBAN:</strong> @(_student.IBAN ?? "-")</MudText>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <MudTabPanel Text="Burs Bilgileri" Icon="@Icons.Material.Filled.CurrencyLira">
                    <MudGrid Class="mt-4">
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2"><strong>Bağışçı:</strong> @_student.BagisciAdi</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2"><strong>Aylık Tutar:</strong> @_student.AylikTutar.ToString("N2") ₺</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2"><strong>Başlangıç:</strong> @_student.BursBaslangicTarihi?.ToString("dd.MM.yyyy")</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2"><strong>Bitiş:</strong> @_student.BursBitisTarihi?.ToString("dd.MM.yyyy")</MudText>
                        </MudItem>
                        <MudItem xs="12">
                            <MudPaper Elevation="2" Class="pa-4">
                                <MudText Typo="Typo.h6" Class="mb-2">Burs Özeti</MudText>
                                <MudText Typo="Typo.body2"><strong>Dönem İçinde Alınan:</strong> @CalculatePeriodScholarship().ToString("N2") ₺</MudText>
                                <MudText Typo="Typo.body2"><strong>Bugüne Kadar Toplam:</strong> @_student.ToplamAlinanBurs.ToString("N2") ₺</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12">
                            @if (_student.AktifBursMu)
                            {
                                <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">Aktif Burs</MudChip>
                            }
                            else if (!string.IsNullOrEmpty(_student.ScholarshipCutReason))
                            {
                                <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mt-2">
                                    <MudText Typo="Typo.body2"><strong>Burs Kesim Sebebi:</strong> @_student.ScholarshipCutReason</MudText>
                                    @if (_student.ScholarshipCutDate.HasValue)
                                    {
                                        <MudText Typo="Typo.body2"><strong>Kesim Tarihi:</strong> @_student.ScholarshipCutDate.Value.ToString("dd.MM.yyyy HH:mm")</MudText>
                                    }
                                </MudAlert>
                            }
                            else if (!string.IsNullOrEmpty(_student.Notlar))
                            {
                                @if (_student.Notlar.Contains("Transkript"))
                                {
                                    <MudChip T="string" Color="Color.Error" Icon="@Icons.Material.Filled.Cancel">Bursu Kesildi (Transkript)</MudChip>
                                }
                                else if (_student.Notlar.Contains("Toplantı"))
                                {
                                    <MudChip T="string" Color="Color.Error" Icon="@Icons.Material.Filled.Cancel">Bursu Kesildi (Toplantıya Katılmama)</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Color="Color.Default">Burs Yok</MudChip>
                                }
                            }
                            else
                            {
                                <MudChip T="string" Color="Color.Default">Burs Yok</MudChip>
                            }
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <MudTabPanel Text="Transkript" Icon="@Icons.Material.Filled.Receipt">
                    <div class="mt-4">
                        @if (!string.IsNullOrWhiteSpace(_latestTranscriptNote))
                        {
                            <MudAlert Severity="Severity.Info" Class="mb-4">
                                <strong>Son Transkript Notu:</strong> @_latestTranscriptNote
                            </MudAlert>
                        }
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                                   StartIcon="@Icons.Material.Filled.Add" 
                                   OnClick="OpenAddTranscriptDialog" Class="mb-4">
                            Transkript Ekle
                        </MudButton>
                        
                        @if (_transcripts.Any())
                        {
                            <MudTable Items="@_transcripts" Dense="true">
                                <HeaderContent>
                                    <MudTh>GNO</MudTh>
                                    <MudTh>Giriş Tarihi</MudTh>
                                    <MudTh>Notlar</MudTh>
                                    <MudTh>PDF</MudTh>
                                    <MudTh>İşlemler</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd>
                                        <MudChip T="string" Color="@(context.GNO >= 2.0m ? Color.Success : Color.Error)" Size="Size.Small">
                                            @context.GNO.ToString("0.00")
                                        </MudChip>
                                    </MudTd>
                                    <MudTd>@context.GirisTarihi.ToString("dd.MM.yyyy")</MudTd>
                                    <MudTd>@(string.IsNullOrEmpty(context.Notlar) ? "-" : context.Notlar)</MudTd>
                                    <MudTd>
                                        @if (!string.IsNullOrEmpty(context.PdfDosyaYolu))
                                        {
                                            <MudIconButton Icon="@Icons.Material.Filled.PictureAsPdf" 
                                                           Size="Size.Small" 
                                                           Color="Color.Error"
                                                           Href="@context.PdfDosyaYolu"
                                                           Target="_blank"
                                                           Title="PDF'i Görüntüle" />
                                        }
                                        else
                                        {
                                            <span>-</span>
                                        }
                                    </MudTd>
                                    <MudTd>
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                       Size="Size.Small" 
                                                       Color="Color.Error" 
                                                       OnClick="@(() => DeleteTranscript(context.Id))" />
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">Henüz transkript kaydı bulunmamaktadır.</MudAlert>
                        }
                    </div>
                </MudTabPanel>
                
                <MudTabPanel Text="Mezuniyet" Icon="@Icons.Material.Filled.School">
                    <div class="mt-4">
                        @if (_student.MezunMu)
                        {
                            <MudAlert Severity="Severity.Success" Class="mb-4">
                                <strong>Mezuniyet Tarihi:</strong> @_student.MezuniyetTarihi?.ToString("dd.MM.yyyy")
                            </MudAlert>
                            
                            <MudGrid Class="mt-4">
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.body2"><strong>Meslek:</strong> @(!string.IsNullOrEmpty(_student.Meslek) ? _student.Meslek : "-")</MudText>
                                </MudItem>
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.body2"><strong>Çalıştığı Firma:</strong> @(!string.IsNullOrEmpty(_student.Firma) ? _student.Firma : "-")</MudText>
                                </MudItem>
                            </MudGrid>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Class="mb-4">
                                Bu öğrenci henüz mezun olmamıştır.
                            </MudAlert>
                            
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Success" 
                                       StartIcon="@Icons.Material.Filled.School"
                                       OnClick="OpenGraduateDialog">
                                Mezun Et
                            </MudButton>
                        }
                    </div>
                </MudTabPanel>

                <MudTabPanel Text="Toplantılar" Icon="@Icons.Material.Filled.EventAvailable">
                    <div class="mt-4">
                        @if (_meetingAttendances.Count == 0)
                        {
                            <MudAlert Severity="Severity.Info">Bu öğrenci için toplantı kaydı bulunamadı.</MudAlert>
                        }
                        else
                        {
                            <MudTable Items="@_meetingAttendances" Dense="true">
                                <HeaderContent>
                                    <MudTh>Tarih</MudTh>
                                    <MudTh>Tür</MudTh>
                                    <MudTh>Lokasyon</MudTh>
                                    <MudTh>Saat Aralığı</MudTh>
                                    <MudTh>Not</MudTh>
                                    <MudTh>Katılım</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Tarih">@context.Meeting.Tarih.ToString("dd.MM.yyyy")</MudTd>
                                    <MudTd DataLabel="Tür">@context.Meeting.ToplantiTuru</MudTd>
                                    <MudTd DataLabel="Lokasyon">@(string.IsNullOrWhiteSpace(context.Meeting.Konum) ? "-" : context.Meeting.Konum)</MudTd>
                                    <MudTd DataLabel="Saat Aralığı">@context.Meeting.Tarih.ToString("HH:mm") - @context.Meeting.BitisTarihi.ToString("HH:mm")</MudTd>
                                    <MudTd DataLabel="Not">@(string.IsNullOrWhiteSpace(context.Meeting.Aciklama) ? "-" : context.Meeting.Aciklama)</MudTd>
                                    <MudTd DataLabel="Katılım">
                                        <MudCheckBox T="bool"
                                                     Value="@context.Katildi"
                                                     Color="Color.Primary"
                                                     Label="Katıldı"
                                                     ValueChanged="@(value => UpdateAttendanceAsync(context, value))" />
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                    </div>
                </MudTabPanel>

                <MudTabPanel Text="Hareket Logları" Icon="@Icons.Material.Filled.History">
                    <div class="mt-4">
                        @if (_activityLogs.Count == 0)
                        {
                            <MudAlert Severity="Severity.Info">Bu öğrenci için hareket logu bulunamadı.</MudAlert>
                        }
                        else
                        {
                            <MudTable Items="@_activityLogs" Dense="true" Hover="true">
                                <HeaderContent>
                                    <MudTh>Tarih</MudTh>
                                    <MudTh>İşlem Tipi</MudTh>
                                    <MudTh>Detay</MudTh>
                                    <MudTh>Kullanıcı</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Tarih">@context.Tarih.ToString("dd.MM.yyyy HH:mm")</MudTd>
                                    <MudTd DataLabel="İşlem Tipi">
                                        <MudChip T="string" Size="Size.Small" Color="@GetLogTypeColor(context.IslemTipi)">
                                            @GetLogTypeText(context.IslemTipi)
                                        </MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Detay">@context.Detay</MudTd>
                                    <MudTd DataLabel="Kullanıcı">@context.KullaniciAdi</MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                    </div>
                </MudTabPanel>
            </MudTabs>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="Close">Kapat</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public int StudentId { get; set; }

    private Student? _student;
    private List<TranscriptRecord> _transcripts = new();
    private List<StudentMeetingAttendance> _meetingAttendances = new();
    private List<ActivityLog> _activityLogs = new();
    private bool _loading = true;
    private bool _disposed = false;
    private int _activePanelIndex = 0;
    private string _latestTranscriptNote = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        if (StudentId > 0)
        {
            await LoadDataAsync();
        }
    }

    private async Task LoadDataAsync()
    {
        if (_disposed) return;
        
        _loading = true;
        try
        {
            _student = await StudentService.GetByIdAsync(StudentId);
            if (_student != null && !_disposed)
            {
                _transcripts = await TranscriptService.GetByStudentIdAsync(StudentId);
                var latestTranscript = _transcripts.FirstOrDefault();
                _latestTranscriptNote = latestTranscript != null ? $"GNO: {latestTranscript.GNO:0.00}" : string.Empty;
                _meetingAttendances = await MeetingService.GetAttendancesForStudentAsync(StudentId);
                _activityLogs = await ActivityLogService.GetByPersonNameAsync(_student.AdSoyad);
            }
        }
        catch (ObjectDisposedException)
        {
            // Component disposed during async operation, ignore
        }
        catch (Exception ex)
        {
            if (!_disposed)
            {
                Snackbar?.Add($"Veri yüklenirken hata: {ex.Message}", Severity.Error);
            }
        }
        finally
        {
            if (!_disposed)
            {
                _loading = false;
            }
        }
    }

    private decimal CalculatePeriodScholarship()
    {
        if (_student == null || !_student.BursBaslangicTarihi.HasValue || !_student.BursBitisTarihi.HasValue)
            return 0;

        var start = _student.BursBaslangicTarihi.Value;
        var end = _student.BursBitisTarihi.Value > DateTime.Now ? DateTime.Now : _student.BursBitisTarihi.Value;
        
        if (end <= start)
            return 0;

        var months = ((end.Year - start.Year) * 12) + end.Month - start.Month + 1;
        return _student.AylikTutar * months;
    }

    private async Task OpenAddTranscriptDialog()
    {
        var parameters = new DialogParameters 
        { 
            ["StudentId"] = StudentId 
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<TranscriptDialog>("Transkript Ekle", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && !_disposed)
        {
            try
            {
                _transcripts = await TranscriptService.GetByStudentIdAsync(StudentId);
                var latestTranscript = _transcripts.FirstOrDefault();
                _latestTranscriptNote = latestTranscript != null ? $"GNO: {latestTranscript.GNO:0.00}" : string.Empty;
                
                if (!_disposed)
                {
                    StateHasChanged();
                }
            }
            catch (ObjectDisposedException)
            {
                // Component disposed, ignore
            }
            catch (Exception ex)
            {
                if (!_disposed)
                {
                    Snackbar?.Add($"Transkript yenilenirken hata: {ex.Message}", Severity.Error);
                }
            }
        }
    }

    private async Task DeleteTranscript(int transcriptId)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Onayla",
            "Bu transkript kaydını silmek istediğinizden emin misiniz?",
            yesText: "Sil", cancelText: "İptal");

        if (result == true && !_disposed)
        {
            try
            {
                await TranscriptService.DeleteAsync(transcriptId);
                _transcripts = await TranscriptService.GetByStudentIdAsync(StudentId);
                var latestTranscript = _transcripts.FirstOrDefault();
                _latestTranscriptNote = latestTranscript != null ? $"GNO: {latestTranscript.GNO:0.00}" : string.Empty;
                
                if (!_disposed)
                {
                    StateHasChanged();
                }
            }
            catch (ObjectDisposedException)
            {
                // Component disposed, ignore
            }
            catch (Exception ex)
            {
                if (!_disposed)
                {
                    Snackbar?.Add($"Transkript silinirken hata: {ex.Message}", Severity.Error);
                }
            }
        }
    }

    private async Task OpenGraduateDialog()
    {
        var parameters = new DialogParameters();
        var options = new DialogOptions { MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<GraduateStudentDialog>("Öğrenciyi Mezun Et", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is GraduateStudentDialog.GraduationResult graduationResult)
        {
            await StudentService.GraduateStudentAsync(StudentId, graduationResult.MezuniyetTarihi, graduationResult.Meslek, graduationResult.Firma);
            _student = await StudentService.GetByIdAsync(StudentId);
            Snackbar.Add($"{_student?.AdSoyad} mezun edildi.", Severity.Success);
            StateHasChanged();
        }
    }

    private void Close()
    {
        _disposed = true;
        MudDialog.Close(DialogResult.Ok(true));
    }
    
    public void Dispose()
    {
        _disposed = true;
    }

    private async Task UpdateAttendanceAsync(StudentMeetingAttendance attendance, bool katildi)
    {
        await MeetingService.UpdateAttendanceAsync(attendance.Id, katildi);
        attendance.Katildi = katildi;
        Snackbar.Add("Katılım durumu güncellendi.", Severity.Success);
    }

    private Color GetLogTypeColor(string islemTipi)
    {
        return islemTipi switch
        {
            "OgrenciEkle" => Color.Success,
            "OgrenciGuncelle" => Color.Info,
            "OgrenciSil" => Color.Error,
            "OgrenciMezun" => Color.Warning,
            _ => Color.Default
        };
    }

    private string GetLogTypeText(string islemTipi)
    {
        return islemTipi switch
        {
            "OgrenciEkle" => "Ekleme",
            "OgrenciGuncelle" => "Güncelleme",
            "OgrenciSil" => "Silme",
            "OgrenciMezun" => "Mezuniyet",
            _ => islemTipi
        };
    }
}
