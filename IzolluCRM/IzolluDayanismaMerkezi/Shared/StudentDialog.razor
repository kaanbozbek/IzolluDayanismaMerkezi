@inject StudentService StudentService
@inject SettingsService SettingsService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_success">
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_student.AdSoyad" Label="Ad Soyad" Required="true" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_student.TCNo" Label="TC No" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_student.Email" Label="Email" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_student.Telefon" Label="Telefon" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <label class="form-label">Doğum Tarihi</label>
                    <InputDate @bind-Value="_dogumTarihi" class="form-control" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <label class="form-label">Cinsiyet</label>
                    <select class="selectpicker form-control" data-live-search="true" title="Seçiniz" @bind="_student.Cinsiyet">
                        @foreach (var gender in _genderOptions)
                        {
                            <option value="@gender">@gender</option>
                        }
                    </select>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudCheckBox T="bool" Value="_student.IsIzollulu" ValueChanged="OnIsIzolluluChanged" Label="İzollulu mu?" Color="Color.Secondary" />
                </MudItem>
                <MudItem xs="12" md="6">
                    @if (_student.IsIzollulu)
                    {
                        <label class="form-label">Köy</label>
                        <select class="selectpicker form-control" data-live-search="true" title="Seçiniz" @bind="_student.Koy">
                            @foreach (var village in _izolluVillages)
                            {
                                <option value="@village">@village</option>
                            }
                        </select>
                    }
                    else
                    {
                        <label class="form-label">İl</label>
                        <select class="selectpicker form-control" data-live-search="true" title="Seçiniz" @bind="_student.Koy">
                            @foreach (var province in _turkishProvinces)
                            {
                                <option value="@province">@province</option>
                            }
                        </select>
                    }
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_student.EbeveynAdi" Label="Ebeveyn Adı" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_student.EbeveynTelefon" Label="Ebeveyn Telefon" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_student.Adres" Label="Adres" Lines="2" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <label class="form-label">Üniversite</label>
                    <select class="selectpicker form-control" data-live-search="true" title="Seçiniz" @bind="_student.Universite">
                        @foreach (var uni in _universities)
                        {
                            <option value="@uni">@uni</option>
                        }
                    </select>
                </MudItem>
                <MudItem xs="12" md="6">
                    <label class="form-label">Bölüm</label>
                    <select class="selectpicker form-control" data-live-search="true" title="Seçiniz" @bind="_student.Bolum">
                        @foreach (var bolum in _bolumler)
                        {
                            <option value="@bolum">@bolum</option>
                        }
                    </select>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudNumericField @bind-Value="_student.Sinif" Label="Sınıf" Min="1" Max="6" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_student.Referans" Label="Referans" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <label class="form-label">Burs Başlangıç Tarihi</label>
                    <InputDate @bind-Value="_bursBaslangic" class="form-control" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <label class="form-label">Burs Bitiş Tarihi</label>
                    <InputDate @bind-Value="_bursBitis" class="form-control" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_student.SicilNumarasi" Label="Sicil Numarası" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_student.IBAN" Label="IBAN" MaxLength="34" />
                </MudItem>
                <MudItem xs="12">
                    <MudCheckBox T="bool" @bind-Value="_student.AktifBursMu" Label="Aktif Burs" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_student.Notlar" 
                                  Label="Notlar" 
                                  Lines="3" 
                                  Placeholder="Öğrenci ile ilgili genel notları buraya yazabilirsiniz..."
                                  HelperText="Öğrenci hakkında önemli notları ekleyin" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">İptal</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" Disabled="@(!_success)">Kaydet</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public bool IsEdit { get; set; }
    [Parameter] public Student? Student { get; set; }

    private MudForm _form = null!;
    private bool _success;
    private Student _student = new();
    private DateTime? _dogumTarihi;
    private DateTime? _bursBaslangic;
    private DateTime? _bursBitis;
    private List<string> _universities = new();
    private List<string> _bolumler = new();
    private readonly List<string> _genderOptions = new() { "Kadın", "Erkek", "Diğer" };

    private readonly List<string> _izolluVillages = new()
    {
        "Abuşoğlu", "Akça", "Akuşağı", "Bağlıca", "Bentköy", "Çanakçı", "Darıpınar", "Dedeköy",
        "Düztarla", "Erdemli", "Gülenköy", "Güneyce", "İkizpınar", "Kaleköy", "Karaağaç",
        "Karahüseyin", "Kıyıcak", "Kozluk", "Kumluyazı", "Mahmut Dursun", "Salkımlı", "Sarıot",
        "Soğukpınar", "Tepebaşı", "Uyanık", "Uzunhüseyin", "Üçdeğirmen", "Yenidamlar"
    };

    private readonly List<string> _turkishProvinces = new()
    {
        "Adana", "Adıyaman", "Afyonkarahisar", "Ağrı", "Aksaray", "Amasya", "Ankara", "Antalya",
        "Ardahan", "Artvin", "Aydın", "Balıkesir", "Bartın", "Batman", "Bayburt", "Bilecik",
        "Bingöl", "Bitlis", "Bolu", "Burdur", "Bursa", "Çanakkale", "Çankırı", "Çorum",
        "Denizli", "Diyarbakır", "Düzce", "Edirne", "Elazığ", "Erzincan", "Erzurum", "Eskişehir",
        "Gaziantep", "Giresun", "Gümüşhane", "Hakkari", "Hatay", "Iğdır", "Isparta", "İstanbul",
        "İzmir", "Kahramanmaraş", "Karabük", "Karaman", "Kars", "Kastamonu", "Kayseri", "Kilis",
        "Kırıkkale", "Kırklareli", "Kırşehir", "Kocaeli", "Konya", "Kütahya", "Malatya", "Manisa",
        "Mardin", "Mersin", "Muğla", "Muş", "Nevşehir", "Niğde", "Ordu", "Osmaniye",
        "Rize", "Sakarya", "Samsun", "Şanlıurfa", "Siirt", "Sinop", "Şırnak", "Sivas",
        "Tekirdağ", "Tokat", "Trabzon", "Tunceli", "Uşak", "Van", "Yalova", "Yozgat", "Zonguldak"
    };

    private void OnIsIzolluluChanged(bool value)
    {
        _student.IsIzollulu = value;
        _student.Koy = null; // Clear the selection when changing between villages and provinces
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        // Üniversite ve bölüm listelerini ayarlardan yükle
        _universities = await SettingsService.GetListValueAsync("Universiteler");
        _bolumler = await SettingsService.GetListValueAsync("Bolumler");
        

        if (IsEdit && Student != null)
        {
            _student = Student;
            _dogumTarihi = _student.DogumTarihi;
            _bursBaslangic = _student.BursBaslangicTarihi;
            _bursBitis = _student.BursBitisTarihi;
        }
        else
        {
            _student.Meslek = "Öğrenci";
            
            // Load default scholarship amount from settings
            var defaultAmount = await SettingsService.GetDecimalValueAsync("DefaultBursTutari", 3000);
            _student.AylikTutar = defaultAmount;
        }
    }

    private async Task Submit()
    {
        await _form.Validate();
        if (!_success)
            return;

        if (string.IsNullOrWhiteSpace(_student.Universite) || string.IsNullOrWhiteSpace(_student.Bolum))
        {
            Snackbar.Add("Üniversite ve bölüm seçmelisiniz.", Severity.Warning);
            return;
        }

        _student.DogumTarihi = _dogumTarihi;
        _student.BursBaslangicTarihi = _bursBaslangic;
        _student.BursBitisTarihi = _bursBitis;

        try
        {
            if (IsEdit)
            {
                await StudentService.UpdateAsync(_student);
            }
            else
            {
                await StudentService.CreateAsync(_student);
            }

            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (InvalidOperationException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
    }

    private void Cancel() => MudDialog.Cancel();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await JS.InvokeVoidAsync("eval", "$('.selectpicker').selectpicker();");
            }
            catch (JSDisconnectedException)
            {
                // Component disposed, ignore
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing selectpicker: {ex.Message}");
            }
        }
    }
}