@inject StudentService StudentService
@inject TranscriptService TranscriptService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        @if (_loading)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (_student != null)
        {
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6">@_student.AdSoyad</MudText>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.body2"><strong>Üniversite:</strong> @_student.Universite</MudText>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.body2"><strong>Bölüm:</strong> @_student.Bolum</MudText>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.body2"><strong>Cinsiyet:</strong> @_student.Cinsiyet</MudText>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.body2"><strong>Bağışçı:</strong> @_student.BagisciAdi</MudText>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.body2"><strong>Aylık Tutar:</strong> @_student.AylikTutar.ToString("N2") ₺</MudText>
                </MudItem>
                <MudItem xs="12">
                    <MudDivider Class="my-4" />
                </MudItem>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-2">Mezuniyet İşlemi</MudText>
                    <label class="form-label">Mezuniyet Tarihi</label>
                    <InputDate @bind-Value="_graduationDate" class="form-control" max="@_todayIso" />
                </MudItem>
                <MudItem xs="12">
                    <MudButton Variant="Variant.Filled" Color="Color.Success" 
                               OnClick="GraduateStudent" FullWidth="true"
                               Disabled="@(_graduationDate == null)">
                        Mezun Et
                    </MudButton>
                </MudItem>
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Kapat</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public int StudentId { get; set; }
    [Parameter] public bool ShowGraduateButton { get; set; }

    private Student? _student;
    private bool _loading = true;
    private DateTime? _graduationDate = DateTime.Now;
    private readonly string _todayIso = DateTime.Now.ToString("yyyy-MM-dd");

    protected override async Task OnInitializedAsync()
    {
        _student = await StudentService.GetByIdAsync(StudentId);
        _loading = false;
    }

    private async Task GraduateStudent()
    {
        if (_graduationDate.HasValue && _student != null)
        {
            await StudentService.GraduateStudentAsync(_student.Id, _graduationDate.Value);
            MudDialog.Close(DialogResult.Ok(true));
        }
    }

    private void Cancel() => MudDialog.Cancel();
}