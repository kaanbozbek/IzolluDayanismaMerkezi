@page "/donors"
@inject DonorService DonorService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>İş Adamları - İzollu Dayanışma Merkezi</PageTitle>

<ListPageLayout>
    
    <Header>
        <MudText Typo="Typo.h4" GutterBottom="true">İş Adamları</MudText>
    </Header>

    <Stats>
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Elevation="3" Class="pa-4" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px;">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.subtitle2" Style="opacity: 0.9;">Toplam Bağışçı</MudText>
                            <MudText Typo="Typo.h4" Style="font-weight: 600;">@TotalDonors</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.BusinessCenter" Size="Size.Large" Style="opacity: 0.8;" />
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudPaper Elevation="3" Class="pa-4" Style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 15px;">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.subtitle2" Style="opacity: 0.9;">Toplam Burs Sayısı</MudText>
                            <MudText Typo="Typo.h4" Style="font-weight: 600;">@TotalScholarships</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.School" Size="Size.Large" Style="opacity: 0.8;" />
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudPaper Elevation="3" Class="pa-4" Style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 15px;">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.subtitle2" Style="opacity: 0.9;">Toplam Tutar</MudText>
                            <MudText Typo="Typo.h4" Style="font-weight: 600;">@TotalAmount.ToString("N0") ₺</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Large" Style="opacity: 0.8;" />
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </Stats>

    <ToolbarLeft>
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   StartIcon="@Icons.Material.Filled.Add" 
                   OnClick="OpenAddDialog">
            Yeni İş Adamı Ekle
        </MudButton>
        
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Success" 
                   StartIcon="@Icons.Material.Filled.FileDownload" 
                   OnClick="ExportToExcel">
            Excel'e Aktar
        </MudButton>
    </ToolbarLeft>

    <ToolbarRight>
        <MudTextField @bind-Value="_searchString" 
                      Placeholder="Ara..." 
                      Adornment="Adornment.Start" 
                      AdornmentIcon="@Icons.Material.Filled.Search" 
                      Immediate="true" />
    </ToolbarRight>

    <Body>
        <MudTable Items="@_donors" Dense="true" Hover="true" Loading="@_loading" Filter="new Func<Donor, bool>(FilterFunc)">
            <HeaderContent>
                <MudTh>Adı Soyadı</MudTh>
                <MudTh>Mesleği</MudTh>
                <MudTh>Şirketi</MudTh>
                <MudTh>İletişim</MudTh>
                <MudTh>Burs Verdiği Tarih</MudTh>
                <MudTh>Verdiği Burs Sayısı</MudTh>
                <MudTh>Toplam Tutar</MudTh>
                <MudTh>İşlemler</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Adı Soyadı">
                    <MudLink OnClick="@(() => OpenDetailDialog(context))">@context.AdSoyad</MudLink>
                </MudTd>
                <MudTd DataLabel="Mesleği">@context.Meslek</MudTd>
                <MudTd DataLabel="Şirketi">@context.Sirket</MudTd>
                <MudTd DataLabel="İletişim">
                    <div>@context.Telefon</div>
                    <div><small>@context.Email</small></div>
                </MudTd>
                <MudTd DataLabel="Burs Verdiği Tarih">
                    @(context.BursVermeTarihi?.ToString("dd/MM/yyyy") ?? "-")
                </MudTd>
                <MudTd DataLabel="Verdiği Burs Sayısı">@context.BursAdedi</MudTd>
                <MudTd DataLabel="Toplam Tutar">
                    <strong>@context.ToplamTutar.ToString("N0") ₺</strong>
                </MudTd>
                <MudTd DataLabel="İşlemler">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => OpenEditDialog(context))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteDonor(context.Id))" />
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
            </PagerContent>
        </MudTable>
    </Body>

</ListPageLayout>

@code {
    private List<Donor> _donors = new();
    private bool _loading = true;
    private string _searchString = "";

    // Statistics properties
    private int TotalDonors => _donors.Count;
    private int TotalScholarships => _donors.Sum(d => d.BursAdedi);
    private decimal TotalAmount => _donors.Sum(d => d.ToplamTutar);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        var allDonors = await DonorService.GetAllAsync();
        // Son eklenenler üstte olsun
        _donors = allDonors.OrderByDescending(d => d.Id).ToList();
        _loading = false;
    }

    private bool FilterFunc(Donor donor)
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;
        if (donor.AdSoyad.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (donor.Sirket?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        if (donor.Sektor?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        return false;
    }

    private async Task OpenAddDialog()
    {
        var parameters = new DialogParameters { ["IsEdit"] = false };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<DonorDialog>("İş Adamı Ekle", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            Snackbar.Add("İş adamı başarıyla eklendi.", Severity.Success);
        }
    }

    private async Task OpenEditDialog(Donor donor)
    {
        var parameters = new DialogParameters 
        { 
            ["IsEdit"] = true,
            ["Donor"] = donor
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<DonorDialog>("İş Adamı Düzenle", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            Snackbar.Add("İş adamı başarıyla güncellendi.", Severity.Success);
        }
    }

    private async Task OpenDetailDialog(Donor donor)
    {
        var parameters = new DialogParameters { ["Donor"] = donor };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        await DialogService.ShowAsync<DonorDetailDialog>("İş Adamı Detayı", parameters, options);
    }

    private async Task DeleteDonor(int id)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Onayla",
            "Bu iş adamını silmek istediğinizden emin misiniz?",
            yesText: "Sil", cancelText: "İptal");

        if (result == true)
        {
            await DonorService.DeleteAsync(id);
            await LoadData();
            Snackbar.Add("İş adamı silindi.", Severity.Info);
        }
    }

    private async Task ExportToExcel()
    {
        // TODO: Excel export logic
        Snackbar.Add("Excel'e aktarma özelliği yakında eklenecek.", Severity.Info);
    }
}
