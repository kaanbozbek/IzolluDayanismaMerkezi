@page "/test-settings"
@inject SettingsService SettingsService
@inject ApplicationDbContext DbContext
@using IzolluVakfi.Data
@using Microsoft.EntityFrameworkCore

<PageTitle>Test Settings</PageTitle>

<MudText Typo="Typo.h4">Settings Test Page</MudText>

<MudButton OnClick="LoadData" Variant="Variant.Filled" Color="Color.Primary" Class="mt-4">
    Load Settings Data
</MudButton>

<MudDivider Class="my-4" />

@if (_loaded)
{
    <MudText Typo="Typo.h6" Class="mb-2">All Settings in Database:</MudText>
    @if (_allSettings.Any())
    {
        @foreach (var setting in _allSettings)
        {
            <MudCard Class="mb-2">
                <MudCardContent>
                    <MudText Typo="Typo.body1"><strong>Key:</strong> @setting.Key</MudText>
                    <MudText Typo="Typo.body2"><strong>Value Length:</strong> @(setting.Value?.Length ?? 0) chars</MudText>
                    <MudText Typo="Typo.body2"><strong>Description:</strong> @setting.Description</MudText>
                    @if (setting.Key == "Sektorler" && !string.IsNullOrEmpty(setting.Value))
                    {
                        <MudText Typo="Typo.body2" Class="mt-2"><strong>Sectors:</strong></MudText>
                        var sectors = setting.Value.Split('|');
                        <ul>
                            @foreach (var sector in sectors)
                            {
                                <li>@sector</li>
                            }
                        </ul>
                    }
                </MudCardContent>
            </MudCard>
        }
    }
    else
    {
        <MudAlert Severity="Severity.Warning">No settings found in database!</MudAlert>
    }

    <MudDivider Class="my-4" />

    <MudText Typo="Typo.h6" Class="mb-2">Sectors via SettingsService:</MudText>
    @if (_sectors.Any())
    {
        <MudList T="string">
            @foreach (var sector in _sectors)
            {
                <MudListItem T="string">@sector</MudListItem>
            }
        </MudList>
    }
    else
    {
        <MudAlert Severity="Severity.Error">No sectors loaded from SettingsService!</MudAlert>
    }
}

@code {
    private bool _loaded = false;
    private List<IzolluVakfi.Data.Entities.Settings> _allSettings = new();
    private List<string> _sectors = new();

    private async Task LoadData()
    {
        _allSettings = await DbContext.Settings.ToListAsync();
        _sectors = await SettingsService.GetListValueAsync("Sektorler");
        _loaded = true;
        StateHasChanged();
    }
}
