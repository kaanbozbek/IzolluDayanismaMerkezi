@page "/reports"
@inject StudentService StudentService
@inject DonorService DonorService
@inject MemberService MemberService
@inject PdfService PdfService
@inject SettingsService SettingsService
@inject MemberScholarshipCommitmentService CommitmentService
@inject SystemSettingsService SystemSettingsService
@inject AidService AidService
@inject VillageService VillageService
@inject StudentScholarshipStatusService ScholarshipStatusService
@inject TermService TermService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<PageTitle>Analiz ve Raporlar - İzollu Dayanışma Merkezi</PageTitle>

<style>
    .stat-card {
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 16px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        min-height: 90px;
        color: white;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        background: rgba(255,255,255,0.2);
        color: white;
    }
    /* Turuncu - Genel/Dönem */
    .stat-card-orange {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    /* Mavi - Burs ile ilgili */
    .stat-card-blue {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    /* Yeşil - Üye/Bağışçı ile ilgili */
    .stat-card-green {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    /* Mor - Öğrenci ile ilgili */
    .stat-card-purple {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    }
    /* Pembe - Yardım ile ilgili */
    .stat-card-pink {
        background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
    }
    /* Teal - Köy ile ilgili */
    .stat-card-teal {
        background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
    }
    .stat-content {
        flex: 1;
    }
    .stat-label {
        font-size: 0.8rem;
        color: rgba(255,255,255,0.85);
        margin-bottom: 4px;
        font-weight: 500;
    }
    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
    }
    .period-filter-card {
        background: white;
        border-radius: 16px;
        padding: 16px 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .pdf-btn {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%) !important;
        color: white !important;
        border-radius: 12px !important;
        padding: 12px 24px !important;
        font-weight: 600 !important;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3) !important;
    }
    .pdf-btn:hover {
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4) !important;
    }
    .distribution-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: #374151;
        padding: 16px 20px;
        border-bottom: 1px solid #f3f4f6;
    }
    /* Grafik container düzeltmesi */
    .chart-container {
        width: 100%;
        overflow-x: auto;
    }
    
    /* Yatay Bar Grafiği Stilleri */
    .horizontal-bar-chart {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 8px 0;
    }
    .horizontal-bar-row {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .horizontal-bar-label {
        width: 200px;
        min-width: 200px;
        font-size: 0.85rem;
        color: #374151;
        text-align: right;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .horizontal-bar-container {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 8px;
        height: 28px;
        background: #f3f4f6;
        border-radius: 6px;
        overflow: hidden;
        position: relative;
    }
    .horizontal-bar-fill {
        height: 100%;
        border-radius: 6px;
        min-width: 4px;
        transition: width 0.5s ease;
    }
    .horizontal-bar-value {
        position: absolute;
        right: 10px;
        font-size: 0.8rem;
        font-weight: 600;
        color: #374151;
    }
</style>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">

@if (_loading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <!-- Action Toolbar: Dönem Filtresi ve PDF Butonu -->
    <MudPaper Elevation="1" Class="pa-4 mb-4" Style="border-radius: 12px; display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                <div style="max-width: 350px; min-width: 250px;">
                    <label class="form-label" style="font-weight: 600; color: var(--color-gray-700); margin-bottom: 8px;">Dönem Filtresi</label>
                    <select id="report-period-filter" class="selectpicker" data-live-search="true" 
                            data-width="100%" title="Dönem Seçiniz" @onchange="OnReportPeriodChanged">
                        <option value="">Tüm Dönemler</option>
                        @foreach (var period in _academicYears)
                        {
                            <option value="@period" selected="@(_selectedReportPeriod == period)">@period</option>
                        }
                    </select>
                </div>
                <div style="margin-left: auto;">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.PictureAsPdf" 
                               OnClick="GeneratePdfReport"
                               Size="Size.Large"
                               Style="border-radius: 12px; padding: 12px 24px;">
                        PDF Raporu Al
                    </MudButton>
                </div>
            </MudPaper>

            <!-- Genel İstatistikler - Modern Card Design - Gruplu Düzen -->
            <MudGrid Spacing="3" Class="section-gap">
        <!-- Row 1: Dönem (Orange) + Öğrenci Grubu (Purple) -->
        <MudItem xs="6" md="3">
            <div class="stat-card stat-card-orange">
                <div class="stat-icon">
                    <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Style="font-size: 24px;" />
                </div>
                <div class="stat-content">
                    <div class="stat-label">Aktif Dönem</div>
                    <div class="stat-value">@_stats.ActivePeriod</div>
                </div>
            </div>
        </MudItem>
        <MudItem xs="6" md="3">
            <div class="stat-card stat-card-purple">
                <div class="stat-icon">
                    <MudIcon Icon="@Icons.Material.Filled.People" Style="font-size: 24px;" />
                </div>
                <div class="stat-content">
                    <div class="stat-label">Toplam Öğrenci</div>
                    <div class="stat-value">@_stats.TotalStudents</div>
                </div>
            </div>
        </MudItem>
        <MudItem xs="6" md="3">
            <div class="stat-card stat-card-purple">
                <div class="stat-icon">
                    <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Style="font-size: 24px;" />
                </div>
                <div class="stat-content">
                    <div class="stat-label">Mezun Öğrenci</div>
                    <div class="stat-value">@_stats.GraduatedCount</div>
                </div>
            </div>
        </MudItem>
        <MudItem xs="6" md="3">
            <div class="stat-card stat-card-purple">
                <div class="stat-icon">
                    <MudIcon Icon="@Icons.Material.Filled.School" Style="font-size: 24px;" />
                </div>
                <div class="stat-content">
                    <div class="stat-label">Burs Alan Öğrenci</div>
                    <div class="stat-value">@_stats.ActiveScholarships</div>
                </div>
            </div>
        </MudItem>

        <!-- Row 2: Burs Grubu (Blue) -->
        <MudItem xs="6" md="3">
            <div class="stat-card stat-card-blue">
                <div class="stat-icon">
                    <MudIcon Icon="@Icons.Material.Filled.Payments" Style="font-size: 24px;" />
                </div>
                <div class="stat-content">
                    <div class="stat-label">Taahhüt Edilen Burs Tutarı</div>
                    <div class="stat-value">@_stats.PeriodBursTutari.ToString("N0") ₺</div>
                </div>
            </div>
        </MudItem>
        <MudItem xs="6" md="3">
            <div class="stat-card stat-card-blue">
                <div class="stat-icon">
                    <MudIcon Icon="@Icons.Material.Filled.Handshake" Style="font-size: 24px;" />
                </div>
                <div class="stat-content">
                    <div class="stat-label">Taahhüt Edilen</div>
                    <div class="stat-value">@_stats.PledgedCount</div>
                </div>
            </div>
        </MudItem>
        <MudItem xs="6" md="3">
            <div class="stat-card stat-card-blue">
                <div class="stat-icon">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="font-size: 24px;" />
                </div>
                <div class="stat-content">
                    <div class="stat-label">Gerçekleşen Burs</div>
                    <div class="stat-value">@_stats.RealizedCount</div>
                </div>
            </div>
        </MudItem>
        <MudItem xs="6" md="3">
            <div class="stat-card stat-card-blue">
                <div class="stat-icon">
                    <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Style="font-size: 24px;" />
                </div>
                <div class="stat-content">
                    <div class="stat-label">Toplam Ödenen Burs</div>
                    <div class="stat-value">@_stats.TotalPaidScholarship.ToString("N0") ₺</div>
                </div>
            </div>
        </MudItem>

        <!-- Row 3: Üye/İş Adamı (Green) + Yardım (Red) + Köy (Teal) -->
        <MudItem xs="6" md="3">
            <div class="stat-card stat-card-green">
                <div class="stat-icon">
                    <MudIcon Icon="@Icons.Material.Filled.Groups" Style="font-size: 24px;" />
                </div>
                <div class="stat-content">
                    <div class="stat-label">Üye Sayısı</div>
                    <div class="stat-value">@_stats.TotalMembers</div>
                </div>
            </div>
        </MudItem>
        <MudItem xs="6" md="3">
            <div class="stat-card stat-card-green">
                <div class="stat-icon">
                    <MudIcon Icon="@Icons.Material.Filled.VolunteerActivism" Style="font-size: 24px;" />
                </div>
                <div class="stat-content">
                    <div class="stat-label">İş Adamı Sayısı</div>
                    <div class="stat-value">@_stats.TotalDonors</div>
                </div>
            </div>
        </MudItem>
        <MudItem xs="6" md="3">
            <div class="stat-card stat-card-pink">
                <div class="stat-icon">
                    <MudIcon Icon="@Icons.Material.Filled.CardGiftcard" Style="font-size: 24px;" />
                </div>
                <div class="stat-content">
                    <div class="stat-label">Toplam Yardım</div>
                    <div class="stat-value">@_stats.TotalAidsCount</div>
                </div>
            </div>
        </MudItem>
        <MudItem xs="6" md="3">
            <div class="stat-card stat-card-teal">
                <div class="stat-icon">
                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Style="font-size: 24px;" />
                </div>
                <div class="stat-content">
                    <div class="stat-label">Köy Sayısı</div>
                    <div class="stat-value">@_stats.VillageCount</div>
                </div>
            </div>
        </MudItem>
    </MudGrid>

    <!-- Dağılım Tabloları -->
    <MudGrid Spacing="3">
        <MudItem xs="12">
            <div class="distribution-card">
                <div class="section-title">Dağılım Özeti</div>
            </div>
        </MudItem>
        
        <!-- Cinsiyet Dağılımı Chart -->
        <MudItem xs="12" md="4">
            <MudCard Elevation="0" Style="border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.subtitle1" Style="font-weight: 600; color: #374151;">
                            Cinsiyet Bazlı Öğrenci Dağılımı
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (_genderChartData.Any())
                    {
                        <MudChart ChartType="ChartType.Donut" 
                                  InputData="@_genderChartData" 
                                  InputLabels="@_genderLabels"
                                  Width="300px" Height="300px"
                                  ChartOptions="@_genderChartOptions" />
                        <MudStack Row="true" Justify="Justify.Center" Class="mt-2">
                            @for (int i = 0; i < _genderLabels.Length; i++)
                            {
                                var idx = i;
                                <MudChip T="string" Style="@GetGenderChipStyle(_genderLabels[idx])" Size="Size.Small">
                                    @_genderLabels[idx]: @_genderChartData[idx].ToString("F0")
                                </MudChip>
                            }
                        </MudStack>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Dense="true">Cinsiyet verisi bulunamadı.</MudAlert>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Malatya İçi/Dışı Dağılımı -->
        <MudItem xs="12" md="4">
            <MudCard Elevation="0" Style="border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.subtitle1" Style="font-weight: 600; color: #374151;">
                            Malatya İçi/Dışı Öğrenci Dağılımı
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (_locationChartData.Any())
                    {
                        <MudChart ChartType="ChartType.Donut" 
                                  InputData="@_locationChartData" 
                                  InputLabels="@_locationLabels"
                                  Width="300px" Height="300px"
                                  ChartOptions="@(new ChartOptions { ChartPalette = new[] { "#f59e0b", "#ef4444" } })" />
                        <MudStack Row="true" Justify="Justify.Center" Class="mt-2">
                            @for (int i = 0; i < _locationLabels.Length; i++)
                            {
                                var idx = i;
                                <MudChip T="string" Style="@(idx == 0 ? "background-color: #f59e0b; color: white;" : "background-color: #ef4444; color: white;")" Size="Size.Small">
                                    @_locationLabels[idx]: @_locationChartData[idx].ToString("F0")
                                </MudChip>
                            }
                        </MudStack>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Dense="true">Konum verisi bulunamadı.</MudAlert>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudCard Elevation="0" Style="border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.subtitle1" Style="font-weight: 600; color: #374151;">
                            Üyelerin Verdiği Burs Dağılımı
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (_memberScholarshipDetails.Any())
                    {
                        <MudTable Items="@_memberScholarshipDetails.Take(10)" Dense="true" Hover="true" Elevation="0">
                            <HeaderContent>
                                <MudTh>Üye</MudTh>
                                <MudTh>Taahhüt</MudTh>
                                <MudTh>Verilen</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Üye">@context.MemberName</MudTd>
                                <MudTd DataLabel="Taahhüt">@context.PledgedCount</MudTd>
                                <MudTd DataLabel="Verilen">@context.RealizedCount</MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Dense="true">Veri bulunamadı.</MudAlert>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Üniversite Dağılımı - Full Width -->
        <MudItem xs="12">
            <MudCard Elevation="0" Style="border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.subtitle1" Style="font-weight: 600; color: #374151;">
                            Üniversiteye Göre Öğrenci Dağılımı
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent Style="overflow: hidden; max-height: 500px; overflow-y: auto;">
                    @if (_universityData.Any())
                    {
                        <div class="horizontal-bar-chart">
                            @{ var maxValue = _universityData.Values.Max(); }
                            @foreach (var uni in _universityData.OrderByDescending(u => u.Value))
                            {
                                var percentage = maxValue > 0 ? (uni.Value * 100.0 / maxValue) : 0;
                                <div class="horizontal-bar-row">
                                    <div class="horizontal-bar-label" title="@uni.Key">@uni.Key</div>
                                    <div class="horizontal-bar-container">
                                        <div class="horizontal-bar-fill" style="width: @(percentage.ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%; background: linear-gradient(90deg, #8b5cf6, #a78bfa);"></div>
                                        <span class="horizontal-bar-value">@uni.Value</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Dense="true">Üniversite verisi bulunamadı.</MudAlert>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudCard Elevation="3" Style="border-radius: 12px;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.LocationCity" Class="mr-2" />
                            Köylere Göre Yardım Dağılımı (@_stats.ActivePeriod)
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (_villageAidData.Any())
                    {
                        <MudTable Items="@_villageAidData" Dense="true" Hover="true" Elevation="0" FixedHeader="true" Height="300px">
                            <HeaderContent>
                                <MudTh>Köy</MudTh>
                                <MudTh>Yardım Sayısı</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Köy">@context.Key</MudTd>
                                <MudTd DataLabel="Yardım Sayısı">
                                    <MudChip T="string" Size="Size.Small" Color="Color.Secondary">@context.Value</MudChip>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Dense="true">Seçili dönem için köy verisi yok.</MudAlert>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudCard Elevation="3" Style="border-radius: 12px;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.CardMembership" Class="mr-2" />
                            Rol Bazlı Burs Dağılımı (@_stats.ActivePeriod)
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (_roleBasedScholarshipData.Any())
                    {
                        <MudTable Items="@_roleBasedScholarshipData" Dense="true" Hover="true" Elevation="0">
                            <HeaderContent>
                                <MudTh>Rol</MudTh>
                                <MudTh Style="text-align: right;">Taahhüt</MudTh>
                                <MudTh Style="text-align: right;">Gerçekleşen</MudTh>
                                <MudTh Style="text-align: right;">Yüzde</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Rol">
                                    <MudChip T="string" Size="Size.Small" Color="@GetRoleColor(context.Role)">@context.Role</MudChip>
                                </MudTd>
                                <MudTd DataLabel="Taahhüt" Style="text-align: right;">
                                    @context.PledgedCount
                                </MudTd>
                                <MudTd DataLabel="Gerçekleşen" Style="text-align: right;">
                                    @context.RealizedCount
                                </MudTd>
                                <MudTd DataLabel="Yüzde" Style="text-align: right;">
                                    <strong>@context.Percentage.ToString("F1")%</strong>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Dense="true">Seçili dönem için rol verisi yok.</MudAlert>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

}

@code {
    private bool _loading = true;
    private List<IzolluVakfi.Services.MemberScholarshipDetail> _memberScholarshipDetails = new();
    private Dictionary<string, int> _universityData = new();
    private Dictionary<string, int> _villageAidData = new();
    private List<RoleBasedScholarship> _roleBasedScholarshipData = new();
    private ReportStats _stats = new();
    private List<string> _academicYears = new();
    private string _selectedReportPeriod = string.Empty;
    private bool _selectPickerInitialized = false;
    
    // Chart data for gender distribution
    private double[] _genderChartData = Array.Empty<double>();
    private string[] _genderLabels = Array.Empty<string>();
    private ChartOptions _genderChartOptions = new ChartOptions();
    
    // Chart data for location distribution
    private double[] _locationChartData = Array.Empty<double>();
    private string[] _locationLabels = Array.Empty<string>();
    
    // Chart data for university distribution
    private List<ChartSeries> _universityChartSeries = new();
    private string[] _universityChartLabels = Array.Empty<string>();

    protected override async Task OnInitializedAsync()
    {
        // Load periods from settings
        var periodsFromSettings = await SettingsService.GetListValueAsync("AcademicPeriods");
        if (periodsFromSettings.Count > 0)
        {
            // Küçükten büyüğe sırala
            _academicYears = periodsFromSettings.OrderBy(p => p).ToList();
        }
        else
        {
            // Fallback: Generate academic years from 2024-2025 to 2039-2040
            var defaultPeriods = new List<string>();
            for (int startYear = 2024; startYear <= 2039; startYear++)
            {
                defaultPeriods.Add($"{startYear}-{startYear + 1}");
            }
            _academicYears = defaultPeriods.OrderBy(p => p).ToList();
        }
        
        await RefreshReportsAsync();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_selectPickerInitialized)
        {
            _selectPickerInitialized = true;
            await InitializeSelectPickerAsync();
        }
    }
    
    private async Task InitializeSelectPickerAsync()
    {
        try
        {
            await Task.Delay(100);
            await JS.InvokeVoidAsync("bootstrapSelect.init");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Bootstrap select initialization error: {ex.Message}");
        }
    }
    
    private async Task OnReportPeriodChanged(ChangeEventArgs e)
    {
        if (e.Value is string newPeriod)
        {
            _selectedReportPeriod = newPeriod;
            await RefreshReportsAsync();
            StateHasChanged();
        }
    }

    private async Task RefreshReportsAsync()
    {
        _loading = true;
        try
        {
            _stats.ActivePeriod = string.IsNullOrWhiteSpace(_selectedReportPeriod) ? "Tüm Dönemler" : _selectedReportPeriod;

            // Get all students
            var allStudents = await StudentService.GetAllAsync();
            var activeStudents = allStudents.Where(s => s.AktifBursMu).ToList();
            
            // Update basic student stats - Toplam Öğrenci = only non-graduated students (Öğrenciler)
            _stats.TotalStudents = allStudents.Count(s => !s.MezunMu);
            _stats.ActiveScholarships = activeStudents.Count;
            _stats.GraduatedCount = await StudentService.GetGraduatedCountAsync();

            // Calculate amounts from active students
            _stats.TotalAmount = await StudentService.GetTotalActiveScholarshipAmountAsync();

            // Get pledge counts from MemberScholarshipCommitment
            var allCommitments = await CommitmentService.GetAllAsync();
            
            // Filter commitments by selected period if specified
            var filteredCommitments = string.IsNullOrWhiteSpace(_selectedReportPeriod)
                ? allCommitments
                : allCommitments.Where(c => c.AcademicYear == _selectedReportPeriod).ToList();
            
            _stats.PledgedCount = filteredCommitments.Sum(c => c.PledgedCount);
            _stats.RealizedCount = filteredCommitments.Sum(c => c.GivenCount);
            
            // Get global yearly amount from settings (monthly * 8 months)
            var scholarshipAmounts = await SettingsService.GetScholarshipAmountsAsync();
            decimal globalYearlyAmount = 25000m; // Default fallback (3125 * 8)
            
            if (!string.IsNullOrWhiteSpace(_selectedReportPeriod) && scholarshipAmounts.Any())
            {
                var periodAmount = scholarshipAmounts.FirstOrDefault(s => s.Period == _selectedReportPeriod);
                if (periodAmount != null)
                {
                    globalYearlyAmount = periodAmount.Amount * 8; // Monthly to Yearly
                }
            }
            else if (scholarshipAmounts.Any())
            {
                var latestAmount = scholarshipAmounts.OrderByDescending(s => s.Period).FirstOrDefault();
                if (latestAmount != null)
                {
                    globalYearlyAmount = latestAmount.Amount * 8;
                }
            }
            
            // Calculate period scholarship amount: PledgedCount * GlobalYearlyAmount (clean integer result)
            _stats.PeriodBursTutari = _stats.PledgedCount * globalYearlyAmount;
            
            // Calculate realized total amount: RealizedCount * GlobalYearlyAmount
            _stats.RealizedTotalAmount = _stats.RealizedCount * globalYearlyAmount;

            // Calculate Total Paid Scholarship: (Count of Paid Months up to current date) * (Global Monthly Amount * 0.8)
            await CalculateTotalPaidScholarshipAsync();

            // Members and donors
            _stats.TotalMembers = await MemberService.GetTotalCountAsync();
            _stats.TotalDonors = await MemberService.GetDonorCountAsync();

            // Get all aids
            var allAids = await AidService.GetAllAsync();
            
            // Filter aids by selected period if specified
            var filteredAids = string.IsNullOrWhiteSpace(_selectedReportPeriod)
                ? allAids
                : allAids.Where(a => a.AcademicYear == _selectedReportPeriod).ToList();
            
            _stats.TotalAidsCount = filteredAids.Count;
            
            // Get total village count from Villages table
            _stats.VillageCount = await VillageService.GetTotalCountAsync();

            // Update charts/tables with filtered commitments and aids
            await LoadChartsAndTablesAsync(allStudents, filteredCommitments, filteredAids);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task CalculateTotalPaidScholarshipAsync()
    {
        try
        {
            // Step 1: Get Total Active Students (non-graduated students with active scholarship)
            var allStudents = await StudentService.GetAllAsync();
            int totalActiveStudents = allStudents.Count(s => !s.MezunMu && s.AktifBursMu);
            
            // Step 2: Get Global Monthly Amount from settings
            var scholarshipAmounts = await SettingsService.GetScholarshipAmountsAsync();
            decimal globalMonthlyAmount = 3125m; // Default fallback
            
            if (!string.IsNullOrWhiteSpace(_selectedReportPeriod) && scholarshipAmounts.Any())
            {
                var periodAmount = scholarshipAmounts.FirstOrDefault(s => s.Period == _selectedReportPeriod);
                if (periodAmount != null)
                {
                    globalMonthlyAmount = periodAmount.Amount;
                }
            }
            else if (scholarshipAmounts.Any())
            {
                var latestAmount = scholarshipAmounts.OrderByDescending(s => s.Period).FirstOrDefault();
                if (latestAmount != null)
                {
                    globalMonthlyAmount = latestAmount.Amount;
                }
            }
            
            // Step 3: Calculate Monthly Payment Per Student = Global Monthly Amount * 0.80
            decimal monthlyPaymentPerStudent = globalMonthlyAmount * 0.8m;
            
            // Step 4: Determine Elapsed Months (October to current month)
            // Academic year starts in October (month 10)
            var now = DateTime.Now;
            int elapsedMonths = 0;
            
            // Calculate months from October to current month
            // Oct=1, Nov=2, Dec=3, Jan=4, Feb=5, Mar=6, Apr=7, May=8
            if (now.Month >= 10) // Oct, Nov, Dec (same year)
            {
                elapsedMonths = now.Month - 9; // Oct=1, Nov=2, Dec=3
            }
            else if (now.Month >= 1 && now.Month <= 5) // Jan-May (next year)
            {
                elapsedMonths = 3 + now.Month; // Jan=4, Feb=5, Mar=6, Apr=7, May=8
            }
            
            // Step 5: Final Formula: Total Paid = TotalStudents * MonthlyPaymentPerStudent * ElapsedMonths
            _stats.TotalPaidScholarship = totalActiveStudents * monthlyPaymentPerStudent * elapsedMonths;
        }
        catch (Exception ex)
        {
            _stats.TotalPaidScholarship = 0;
            Console.WriteLine($"Error calculating total paid scholarship: {ex.Message}");
        }
    }

    private async Task LoadChartsAndTablesAsync(List<Student> students, List<MemberScholarshipCommitment> commitments, List<Aid> aids)
    {
        // Gender distribution for charts - order: Kadın (pink), Erkek (blue), others
        // Only show active students (not graduates)
        var genderGroups = students
            .Where(s => !s.MezunMu)
            .GroupBy(s => string.IsNullOrEmpty(s.Cinsiyet) ? "Belirtilmemiş" : s.Cinsiyet)
            .ToDictionary(g => g.Key, g => g.Count());
        
        if (genderGroups.Any())
        {
            // Build ordered lists with Kadın first, then Erkek, then others
            var orderedLabels = new List<string>();
            var orderedData = new List<double>();
            var orderedColors = new List<string>();
            
            if (genderGroups.ContainsKey("Kadın"))
            {
                orderedLabels.Add("Kadın");
                orderedData.Add(genderGroups["Kadın"]);
                orderedColors.Add("#ec4899"); // Pink
            }
            if (genderGroups.ContainsKey("Erkek"))
            {
                orderedLabels.Add("Erkek");
                orderedData.Add(genderGroups["Erkek"]);
                orderedColors.Add("#3b82f6"); // Blue
            }
            foreach (var kvp in genderGroups.Where(g => g.Key != "Kadın" && g.Key != "Erkek"))
            {
                orderedLabels.Add(kvp.Key);
                orderedData.Add(kvp.Value);
                orderedColors.Add("#9ca3af"); // Gray for others
            }
            
            _genderLabels = orderedLabels.ToArray();
            _genderChartData = orderedData.ToArray();
            _genderChartOptions = new ChartOptions { ChartPalette = orderedColors.ToArray() };
        }
        
        // Location distribution (Malatya içi/dışı)
        // Only show active students (not graduates)
        var locationGroups = students
            .Where(s => !s.MezunMu)
            .GroupBy(s => s.IsMalatyaUniversity ? "Malatya İçi" : "Malatya Dışı")
            .OrderBy(g => g.Key == "Malatya İçi" ? 0 : 1) // Ensure "Malatya İçi" is always first
            .ToDictionary(g => g.Key, g => g.Count());
        
        if (locationGroups.Any())
        {
            _locationLabels = locationGroups.Keys.ToArray();
            _locationChartData = locationGroups.Values.Select(v => (double)v).ToArray();
        }
        
        // "Üyelerin Verdiği Burs Dağılımı" - show pledged and realized counts
        _memberScholarshipDetails = commitments
            .Where(c => c.Member != null)
            .GroupBy(c => c.Member!.AdSoyad)
            .Select(g => new IzolluVakfi.Services.MemberScholarshipDetail
            {
                MemberName = g.Key,
                PledgedCount = g.Sum(c => c.PledgedCount),
                RealizedCount = g.Sum(c => c.GivenCount)
            })
            .OrderByDescending(d => d.PledgedCount)
            .ToList();

        // "Üniversiteye Göre Öğrenci Dağılımı" - dönem bağımsız tüm öğrenciler
        var allStudentsForUniversity = await StudentService.GetAllAsync();
        _universityData = allStudentsForUniversity
            .Where(s => !string.IsNullOrEmpty(s.Universite))
            .GroupBy(s => s.Universite!)
            .OrderByDescending(g => g.Count())
            .Take(10)
            .ToDictionary(g => g.Key, g => g.Count());
        
        // University chart data
        if (_universityData.Any())
        {
            _universityChartLabels = _universityData.Keys.Select(k => k.Length > 15 ? k.Substring(0, 12) + "..." : k).ToArray();
            _universityChartSeries = new List<ChartSeries>
            {
                new ChartSeries { Name = "Öğrenci", Data = _universityData.Values.Select(v => (double)v).ToArray() }
            };
        }

        // "Köylere Göre Yardım Dağılımı" - dönem filtresine göre
        _villageAidData = aids
            .Where(a => a.IsIzollulu && !string.IsNullOrWhiteSpace(a.Koy))
            .GroupBy(a => a.Koy!)
            .OrderByDescending(g => g.Count())
            .ToDictionary(g => g.Key, g => g.Count());

        // "Rol Bazlı Burs Dağılımı" - dönem filtresine göre
        var allMembers = await MemberService.GetAllAsync();
        var roleData = new List<RoleBasedScholarship>();
        
        // Calculate total pledged from all commitments for percentage calculation
        var totalPledgedForPercentage = commitments.Sum(c => c.PledgedCount);
        var totalRealized = commitments.Sum(c => c.GivenCount);
        
        if (totalPledgedForPercentage > 0)
        {
            // Kurucular Heyeti
            var kurucularCommitments = commitments.Where(c => c.Member != null && c.Member.IsMutevelli).ToList();
            if (kurucularCommitments.Any())
            {
                var kurucularPledged = kurucularCommitments.Sum(c => c.PledgedCount);
                var kurucularRealized = kurucularCommitments.Sum(c => c.GivenCount);
                roleData.Add(new RoleBasedScholarship
                {
                    Role = "Kurucular Heyeti",
                    PledgedCount = kurucularPledged,
                    RealizedCount = kurucularRealized,
                    Percentage = (double)kurucularPledged / totalPledgedForPercentage * 100
                });
            }

            // Yönetim Kurulu
            var yonetimCommitments = commitments.Where(c => c.Member != null && c.Member.IsYonetimKurulu).ToList();
            if (yonetimCommitments.Any())
            {
                var yonetimPledged = yonetimCommitments.Sum(c => c.PledgedCount);
                var yonetimRealized = yonetimCommitments.Sum(c => c.GivenCount);
                roleData.Add(new RoleBasedScholarship
                {
                    Role = "Yönetim Kurulu",
                    PledgedCount = yonetimPledged,
                    RealizedCount = yonetimRealized,
                    Percentage = (double)yonetimPledged / totalPledgedForPercentage * 100
                });
            }

            // Denetim Kurulu
            var denetimCommitments = commitments.Where(c => c.Member != null && c.Member.IsDenetimKurulu).ToList();
            if (denetimCommitments.Any())
            {
                var denetimPledged = denetimCommitments.Sum(c => c.PledgedCount);
                var denetimRealized = denetimCommitments.Sum(c => c.GivenCount);
                roleData.Add(new RoleBasedScholarship
                {
                    Role = "Denetim Kurulu",
                    PledgedCount = denetimPledged,
                    RealizedCount = denetimRealized,
                    Percentage = (double)denetimPledged / totalPledgedForPercentage * 100
                });
            }

            // Diğer Üyeler
            var otherCommitments = commitments.Where(c => c.Member != null && 
                !c.Member.IsMutevelli && !c.Member.IsYonetimKurulu && !c.Member.IsDenetimKurulu).ToList();
            if (otherCommitments.Any())
            {
                var otherPledged = otherCommitments.Sum(c => c.PledgedCount);
                var otherRealized = otherCommitments.Sum(c => c.GivenCount);
                roleData.Add(new RoleBasedScholarship
                {
                    Role = "Diğer Üyeler",
                    PledgedCount = otherPledged,
                    RealizedCount = otherRealized,
                    Percentage = (double)otherPledged / totalPledgedForPercentage * 100
                });
            }
        }
        
        _roleBasedScholarshipData = roleData.OrderByDescending(r => r.Percentage).ToList();
        
        await Task.CompletedTask;
    }

    private Color GetRoleColor(string role)
    {
        return role switch
        {
            "Kurucular Heyeti" => Color.Primary,
            "Yönetim Kurulu" => Color.Secondary,
            "Denetim Kurulu" => Color.Tertiary,
            _ => Color.Default
        };
    }

    private class ReportStats
    {
        public string ActivePeriod { get; set; } = "Belirtilmemiş";
        public int TotalStudents { get; set; }
        public int ActiveScholarships { get; set; }
        public int GraduatedCount { get; set; }
        public int TotalDonors { get; set; }
        public int TotalMembers { get; set; }
        public decimal TotalAmount { get; set; }
        public decimal PeriodBursTutari { get; set; }
        public int PledgedCount { get; set; }
        public int RealizedCount { get; set; }
        public int TotalAidsCount { get; set; }
        public int VillageCount { get; set; }
        public decimal RealizedTotalAmount { get; set; }
        public decimal TotalPaidScholarship { get; set; } // New: Dynamically calculated total paid
    }

    private class RoleBasedScholarship
    {
        public string Role { get; set; } = string.Empty;
        public int PledgedCount { get; set; }
        public int RealizedCount { get; set; }
        public double Percentage { get; set; }
    }

    private async Task GeneratePdfReport()
    {
        try
        {
            // Get all students for distribution calculations
            var allStudents = await StudentService.GetAllAsync();
            
            // Filter to active students only (exclude graduates) - same as dashboard
            var activeStudents = allStudents.Where(s => !s.MezunMu).ToList();
            
            // Calculate gender distribution (active students only)
            var genderDistribution = activeStudents
                .GroupBy(s => string.IsNullOrEmpty(s.Cinsiyet) ? "Belirtilmemiş" : s.Cinsiyet)
                .ToDictionary(g => g.Key, g => g.Count());

            // Calculate Malatya location distribution (active students only)
            var malatyaLocationDistribution = activeStudents
                .GroupBy(s => s.IsMalatyaUniversity ? "Malatya İçi" : "Malatya Dışı")
                .ToDictionary(g => g.Key, g => g.Count());

            // Get top 10 donors by realized count
            var topDonors = _memberScholarshipDetails
                .OrderByDescending(x => x.RealizedCount)
                .Take(10)
                .ToList();

            // Get unfulfilled commitments
            var unfulfilledCommitments = _memberScholarshipDetails
                .Where(x => x.PledgedCount > x.RealizedCount)
                .OrderByDescending(x => x.PledgedCount - x.RealizedCount)
                .ToList();

            var pdfBytes = PdfService.GenerateComprehensiveReport(
                totalStudents: _stats.TotalStudents,
                activeScholarships: _stats.ActiveScholarships,
                graduatedCount: _stats.GraduatedCount,
                totalDonors: _stats.TotalDonors,
                totalMembers: _stats.TotalMembers,
                totalPaidScholarship: _stats.TotalPaidScholarship,  // Changed from TotalAmount to match Dashboard
                activePeriod: _stats.ActivePeriod,
                periodBursTutari: _stats.PeriodBursTutari,
                pledgedCount: _stats.PledgedCount,
                realizedCount: _stats.RealizedCount,
                totalAidsCount: _stats.TotalAidsCount,
                villageCount: _stats.VillageCount,
                universityData: _universityData,
                memberScholarshipDetails: _memberScholarshipDetails,
                genderDistribution: genderDistribution,
                malatyaLocationDistribution: malatyaLocationDistribution,
                topDonors: topDonors,
                unfulfilledCommitments: unfulfilledCommitments,
                villageAidData: _villageAidData,
                roleBasedScholarshipData: _roleBasedScholarshipData.Select(r => new IzolluVakfi.Services.RoleBasedScholarshipPdf 
                { 
                    Role = r.Role, 
                    PledgedCount = r.PledgedCount, 
                    RealizedCount = r.RealizedCount, 
                    Percentage = r.Percentage 
                }).ToList()
            );
            
            await JS.InvokeVoidAsync("downloadFile", $"kapsamli_rapor_{DateTime.Now:yyyyMMdd_HHmmss}.pdf", Convert.ToBase64String(pdfBytes));
            Snackbar.Add("Kapsamlı PDF raporu oluşturuldu.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
        }
    }
    
    private string GetGenderChipStyle(string gender)
    {
        return gender switch
        {
            "Kadın" => "background-color: #ec4899; color: white;",
            "Erkek" => "background-color: #3b82f6; color: white;",
            _ => "background-color: #9ca3af; color: white;"
        };
    }
}

</MudContainer>
